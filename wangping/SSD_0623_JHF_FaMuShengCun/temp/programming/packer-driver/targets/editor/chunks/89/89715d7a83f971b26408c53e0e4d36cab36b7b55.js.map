{"version":3,"sources":["file:///D:/Cocos/PlayAble/SSD_0623_JHF_FaMuShengCun/assets/JavaScript/UI/UIJoyStick.ts"],"names":["_decorator","CCFloat","Component","Input","math","Node","Sprite","UIOpacity","v3","Vec3","VirtualInput","DataManager","ccclass","property","UIJoyStick","initJoyStickBgPosition","uiOpacity","t","loopCount","isPaused","pauseTimer","handStartPos","start","Instance","isTouching","node","getComponent","addComponent","opacity","uiJoyStick","on","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","joyStickBg","worldPosition","hand","getPosition","clone","onDestroy","off","event","cameraGuiding","isStartGame","isDeactivateVirtualJoystick","isGameEnd","active","x","touch","getUILocationX","y","getUILocationY","setWorldPosition","worldPos","localPos","inverseTransformPoint","thumbnailPos","len","length","normalize","scaleAndAdd","clamp","radius","thumbnail","setPosition","horizontal","position","vertical","ZERO","update","dt","pauseDuration","speed","xRaw","amplitudeX","Math","sin","yRaw","amplitudeY","cos","offset","handPos","add","PI"],"mappings":"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","sourcesContent":["import { _decorator, CCFloat, Component, EventTouch, Input, math, Node, Sprite, UIOpacity, v3, Vec3 } from 'cc';\r\nimport { VirtualInput } from '../Input/VirtuallInput';\r\nimport { DataManager } from '../Global/DataManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('UIJoyStick')\r\nexport class UIJoyStick extends Component {\r\n    @property(Sprite)\r\n    thumbnail: Sprite | null = null;\r\n\r\n    @property(Sprite)\r\n    joyStickBg: Sprite | null = null;\r\n\r\n    @property(Node)\r\n    hand: Node | null = null;\r\n\r\n    @property(CCFloat)\r\n    radius: number = 130;\r\n\r\n    initJoyStickBgPosition: Vec3 = v3();\r\n\r\n    uiOpacity = null;\r\n\r\n    @property\r\n    amplitudeX: number = 50;\r\n\r\n    @property\r\n    amplitudeY: number = 80;\r\n\r\n    @property\r\n    speed: number = 0.3;\r\n\r\n    @property\r\n    pauseDuration: number = 1.0; // 停顿时间（秒）\r\n\r\n    private t = 0;\r\n    private loopCount = 0;\r\n    private isPaused = false;\r\n    private pauseTimer = 0;\r\n    private handStartPos: Vec3 = new Vec3();\r\n\r\n    start() {\r\n        if (DataManager.Instance.isTouching) {\r\n            this.uiOpacity = this.node.getComponent(UIOpacity) || this.node.addComponent(UIOpacity);\r\n            this.uiOpacity.opacity = 0;\r\n        }\r\n\r\n        DataManager.Instance.uiJoyStick = this;\r\n\r\n        this.node.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.node.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this)\r\n        this.node.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.on(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n\r\n        this.initJoyStickBgPosition = this.joyStickBg.node.worldPosition;\r\n\r\n        if (this.hand) {\r\n            this.handStartPos = this.hand.getPosition().clone();\r\n        }\r\n    }\r\n\r\n    onDestroy() {\r\n        this.node.off(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.node.off(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.node.off(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.off(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        if (DataManager.Instance.cameraGuiding) return;\r\n        DataManager.Instance.isStartGame = true;\r\n        if (DataManager.Instance.isDeactivateVirtualJoystick || DataManager.Instance.isGameEnd) return;\r\n        DataManager.Instance.isTouching = true;\r\n        if (this.hand) this.hand.active = false;\r\n\r\n        let x = event.touch.getUILocationX();\r\n        let y = event.touch.getUILocationY();\r\n\r\n        this.joyStickBg.node.setWorldPosition(x, y, 0)\r\n\r\n        if (this.uiOpacity) this.uiOpacity.opacity = 255;\r\n    }\r\n\r\n    onTouchMove(event: EventTouch) {\r\n        if (DataManager.Instance.cameraGuiding) return;\r\n        if (DataManager.Instance.isDeactivateVirtualJoystick || DataManager.Instance.isGameEnd) return;\r\n\r\n        let x = event.touch.getUILocationX();\r\n        let y = event.touch.getUILocationY();\r\n\r\n        let worldPos = new Vec3(x, y, 0);\r\n        let localPos = v3();\r\n\r\n        this.joyStickBg.node.inverseTransformPoint(localPos, worldPos);\r\n        let thumbnailPos = v3();\r\n        let len = localPos.length();\r\n        localPos.normalize();\r\n        Vec3.scaleAndAdd(thumbnailPos, v3(), localPos, math.clamp(len, 0, this.radius));\r\n\r\n        this.thumbnail.node.setPosition(thumbnailPos);\r\n\r\n        VirtualInput.horizontal = this.thumbnail.node.position.x / this.radius;\r\n        VirtualInput.vertical = this.thumbnail.node.position.y / this.radius;\r\n    }\r\n\r\n    onTouchEnd(event: EventTouch) {\r\n        // if (DataManager.Instance.isDeactivateVirtualJoystick) return;\r\n        VirtualInput.horizontal = 0;\r\n        VirtualInput.vertical = 0;\r\n\r\n        this.thumbnail.node.setPosition(Vec3.ZERO);\r\n        this.joyStickBg.node.setWorldPosition(this.initJoyStickBgPosition);\r\n\r\n        if (DataManager.Instance.isTouching) {\r\n            this.uiOpacity = this.node.getComponent(UIOpacity) || this.node.addComponent(UIOpacity);\r\n            this.uiOpacity.opacity = 0;\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (DataManager.Instance.isTouching) return;\r\n\r\n        if (this.isPaused) {\r\n            this.pauseTimer += dt;\r\n            if (this.pauseTimer >= this.pauseDuration) {\r\n                this.pauseTimer = 0;\r\n                this.isPaused = false;\r\n                this.t = 0;\r\n            }\r\n            return;\r\n        }\r\n\r\n        this.t += dt * this.speed;\r\n\r\n        const xRaw = this.amplitudeX * Math.sin(this.t);\r\n        const yRaw = this.amplitudeY * Math.sin(this.t) * Math.cos(this.t);\r\n\r\n        const x = yRaw;\r\n        const y = -xRaw;\r\n\r\n        const offset = new Vec3(x, y, 0);\r\n        this.thumbnail.node.setPosition(offset);\r\n\r\n        if (this.hand) {\r\n            const handPos = this.handStartPos.clone().add(offset);\r\n            this.hand.setPosition(handPos);\r\n        }\r\n\r\n\r\n        if (this.t >= Math.PI * 2) {\r\n            this.loopCount += 1;\r\n            this.t = 0;\r\n\r\n            if (this.loopCount >= 2) {\r\n                this.loopCount = 0;\r\n                this.thumbnail.node.setPosition(Vec3.ZERO);\r\n                if (this.hand) this.hand.setPosition(this.handStartPos);\r\n                this.isPaused = true;\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}