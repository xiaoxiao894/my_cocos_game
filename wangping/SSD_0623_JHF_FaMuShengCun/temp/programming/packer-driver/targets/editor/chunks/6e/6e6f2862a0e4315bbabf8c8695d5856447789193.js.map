{"version":3,"sources":["file:///D:/Cocos/PlayAble/SSD_0623_JHF_FaMuShengCun/assets/JavaScript/Arrow/ArrowManager.ts"],"names":["_decorator","Component","find","instantiate","Node","Quat","UIOpacity","Vec3","DataManager","EntityTypeEnum","TypeItemEnum","ccclass","property","ArrowManager","tooltip","arrowNodes","_plot1","_plot7","_coinCon","_unlockHelper","hideRadius","hideWhileInside","_lastArrowTarget","_pathStart","_pathEnd","_pathDir","_pathLen","_flowOffset","_flowEnabled","start","Instance","arrowTargetNode","update","deltaTime","_tickArrowFlow","player","guideTargetList","cameraGuiding","setArrowCount","arrow3DManager","node","active","currentArrowPointing","guideList","inGuide","length","isEnterPromptArea","targetData","item","isDisplay","coinTransitionCon","coinBackpack","searchBackpackItem","Coin","woodBackpack","Wood","children","initCoinNum","coinNum","unlock","name","plot","shouldHideForTarget","hideArrow","createArrowPathTo","worldPosition","playFloatingEffect","onlyGuidanceOnce","worldPos","x","y","z","playerNode","nearestTree","getNearTree","unlockPowerTowersNum","isUnlockHelper","conditionalJudgment","target","isTree","targetChanged","isPlayerInsideTarget","isValid","distance","typeItem","backpack1","getChildByName","backpack2","backpack3","backpacks","filter","Boolean","sourceBackpack","_findBackpackWithItem","bag","some","child","includes","guideTargetIndex","targetPos","getWorldPosition","set","subtract","normalize","spacing","Math","max","totalCount","floor","_layoutArrows","targetCount","prefab","prefabMap","get","PathArrow","arrow","setParent","push","pop","destroy","dt","speed","flowSpeed","needCount","rot","fromViewUp","UP","count","fadeInRange","fadeOutRange","NEWBORN_KEY","base","pos","distInfos","i","dist","multiplyScalar","add","arrowHeight","setWorldPosition","setWorldRotation","ui","getComponent","addComponent","isNewborn","tIn","min","opacity","alpha","dToEnd","tOut","sort","a","b","last3","slice","fades","k","idx","treeMatrix","treeMRow","treeMCol","c","r","treeNode"],"mappings":"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","sourcesContent":["import { _decorator, Component, find, instantiate, Node, Quat, UIOpacity, Vec3 } from 'cc';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { EntityTypeEnum, TypeItemEnum } from '../Enum/Index';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ArrowManager')\r\nexport class ArrowManager extends Component {\r\n    @property(Node)\r\n    arrowNode: Node = null!;\r\n\r\n    @property(Node)\r\n    target: Node = null!;\r\n\r\n    @property\r\n    spacing: number = 0.5;\r\n\r\n    @property\r\n    flowSpeed: number = 4;\r\n\r\n    @property\r\n    arrowHeight: number = 0.2;      // 箭头Y高度\r\n\r\n    // —— 脚下遮罩 ——\r\n    // 半径（米）：半径内不显示任何箭头\r\n    @property({ tooltip: '脚下遮罩半径（米），半径内不显示箭头' })\r\n    maskRadius: number = 0.8;\r\n\r\n    // 羽化长度（米）：0=硬边；>0 时在 [maskRadius, maskRadius+maskFeather] 线性由 0→1\r\n    @property({ tooltip: '遮罩羽化长度（米），0 表示硬边' })\r\n    maskFeather: number = 0.0;\r\n\r\n\r\n    arrowNodes: Node[] = [];\r\n\r\n    private _plot1: Node | null = null;\r\n    private _plot7: Node | null = null;\r\n    private _coinCon: Node | null = null;\r\n\r\n    // 解锁帮手地块\r\n    _unlockHelper = true;\r\n\r\n    // 玩家进入同一区域后隐藏箭头的半径\r\n    hideRadius: number = 3;\r\n\r\n    // 是否启用“进入同一区域就隐藏箭头”\r\n    hideWhileInside: boolean = true;\r\n\r\n    // 记录上一次指向的目标（用于识别是否刚刚切换目标）\r\n    private _lastArrowTarget: Node | null = null;\r\n\r\n    //\r\n    private _pathStart: Vec3 = new Vec3();\r\n    private _pathEnd: Vec3 = new Vec3();\r\n    private _pathDir: Vec3 = new Vec3(1, 0, 0);\r\n    private _pathLen: number = 0;\r\n    private _flowOffset: number = 0;     // 循环\r\n    private _flowEnabled: boolean = false;\r\n\r\n    start() {\r\n        // 临时\r\n        DataManager.Instance.arrowTargetNode = this;\r\n\r\n        // 交付木头\r\n        this._plot1 = find('THREE3DNODE/Unlock/Plot1');\r\n\r\n        // 收集金币\r\n        this._plot7 = find('THREE3DNODE/Unlock/Plot7');\r\n\r\n        // 场地金币\r\n        this._coinCon = find('THREE3DNODE/PlacingCon/SceneCoinCon');\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n        // 先推进已有路径的箭头流动\r\n        this._tickArrowFlow(deltaTime);\r\n\r\n        if (!DataManager.Instance.arrowTargetNode && !DataManager.Instance.player && !DataManager.Instance.guideTargetList) return;\r\n\r\n        if (DataManager.Instance.cameraGuiding) {\r\n            this.setArrowCount(0);\r\n            this._flowEnabled = false; // 停止流动\r\n            DataManager.Instance.arrow3DManager?.node && (DataManager.Instance.arrow3DManager.node.active = false);\r\n            DataManager.Instance.currentArrowPointing = null;\r\n            this._lastArrowTarget = null;\r\n            return;\r\n        }\r\n\r\n        const guideList = DataManager.Instance.guideTargetList;\r\n        const inGuide = !!(guideList && guideList.length > 0 && DataManager.Instance.isEnterPromptArea);\r\n\r\n        if (inGuide) {\r\n            const targetData = guideList.find(item => item.isDisplay);\r\n\r\n            const coinTransitionCon = find('THREE3DNODE/CoinTransitionCon');\r\n            const coinBackpack = this.searchBackpackItem(TypeItemEnum.Coin);\r\n            const woodBackpack = this.searchBackpackItem(TypeItemEnum.Wood);\r\n\r\n            // —— 分支一：指向解锁点（targetData.plot）——\r\n            if ((targetData && coinBackpack && coinBackpack.children.length >= targetData.initCoinNum / 2) ||\r\n                (targetData && coinBackpack && coinBackpack.children.length >= targetData.coinNum)) {\r\n                const unlock = find('THREE3DNODE/Unlock');\r\n                const node = unlock?.children.find(item => item.name == targetData.plot) as Node | null;\r\n\r\n                if (node) {\r\n                    if (this.shouldHideForTarget(node, /*isTree*/ false)) {\r\n                        this.hideArrow();\r\n                        DataManager.Instance.currentArrowPointing = node;\r\n                        this._lastArrowTarget = node;\r\n                        return;\r\n                    }\r\n                    // 显示箭头\r\n                    DataManager.Instance.arrow3DManager.node.active = true;\r\n                    this.createArrowPathTo(node.worldPosition);\r\n                    DataManager.Instance.arrow3DManager.playFloatingEffect(deltaTime, node.worldPosition, true);\r\n                    DataManager.Instance.currentArrowPointing = node;\r\n                    this._lastArrowTarget = node;\r\n                    return;\r\n                }\r\n            }\r\n            // —— 分支二：满足金币条件则指向 plot7 —— \r\n            else if ((this._coinCon?.children.length ?? 0) + (coinTransitionCon?.children.length ?? 0) > 0\r\n                // (\r\n                //     coinTransitionCon &&\r\n                //     targetData &&\r\n                //     (targetData.coinNum <= ((coinBackpack?.children.length ?? 0) + (this._coinCon?.children.length ?? 0) + (coinTransitionCon?.children.length ?? 0)))\r\n                // ) || (\r\n                //     coinTransitionCon && !DataManager.Instance.isUnlockHelper &&\r\n                //     targetData && (1 <= ((coinBackpack?.children.length ?? 0) + (this._coinCon?.children.length ?? 0) + (coinTransitionCon?.children.length ?? 0)))\r\n                // )\r\n            ) {\r\n                DataManager.Instance.onlyGuidanceOnce = false;\r\n                if (this._plot7) {\r\n                    // if (this.shouldHideForTarget(this._plot7, /*isTree*/ false)) {\r\n                    //     // this.hideArrow();\r\n                    //     DataManager.Instance.currentArrowPointing = this._plot7;\r\n                    //     this._lastArrowTarget = this._plot7;\r\n                    //     return;\r\n                    // }\r\n                    DataManager.Instance.arrow3DManager.node.active = true;\r\n                    this.createArrowPathTo(this._plot7.worldPosition);\r\n                    let worldPos = new Vec3(this._plot7.worldPosition.x, this._plot7.worldPosition.y, this._plot7.worldPosition.z - 1);\r\n                    DataManager.Instance.arrow3DManager.playFloatingEffect(deltaTime, worldPos, true);\r\n                    DataManager.Instance.currentArrowPointing = this._plot7;\r\n                    this._lastArrowTarget = this._plot7;\r\n                    return;\r\n                }\r\n            }\r\n            // —— 分支三：仅场地或背包金币满足，指向 plot7 —— \r\n            else if (targetData && this._coinCon && targetData.coinNum < this._coinCon.children.length) {\r\n                if (this._plot7) {\r\n                    if (this.shouldHideForTarget(this._plot7, /*isTree*/ false)) {\r\n                        this.hideArrow();\r\n                        DataManager.Instance.currentArrowPointing = this._plot7;\r\n                        this._lastArrowTarget = this._plot7;\r\n                        return;\r\n                    }\r\n                    DataManager.Instance.arrow3DManager.node.active = true;\r\n                    this.createArrowPathTo(this._plot7.worldPosition);\r\n                    DataManager.Instance.arrow3DManager.playFloatingEffect(deltaTime, this._plot7.worldPosition, true);\r\n                    DataManager.Instance.currentArrowPointing = this._plot7;\r\n                    this._lastArrowTarget = this._plot7;\r\n                    return;\r\n                }\r\n            }\r\n            // —— 分支四：木材满载则指向 plot1 —— \r\n            else if (woodBackpack && woodBackpack.children.length >= 10) {\r\n                if (this._plot1) {\r\n                    if (this.shouldHideForTarget(this._plot1, /*isTree*/ false)) {\r\n                        this.hideArrow();\r\n                        DataManager.Instance.currentArrowPointing = this._plot1;\r\n                        this._lastArrowTarget = this._plot1;\r\n                        return;\r\n                    }\r\n                    DataManager.Instance.arrow3DManager.node.active = true;\r\n                    this.createArrowPathTo(this._plot1.worldPosition);\r\n                    DataManager.Instance.arrow3DManager.playFloatingEffect(deltaTime, this._plot1.worldPosition, true);\r\n                    DataManager.Instance.currentArrowPointing = this._plot1;\r\n                    this._lastArrowTarget = this._plot1;\r\n                    return;\r\n                }\r\n            }\r\n            // —— 分支五：去砍树（回退，找树永不隐藏箭头）——\r\n            {\r\n                const playerNode = DataManager.Instance.player?.node;\r\n                const nearestTree = playerNode ? this.getNearTree(playerNode) : null;\r\n\r\n                if (nearestTree && nearestTree.worldPosition && DataManager.Instance.unlockPowerTowersNum < 2 && !DataManager.Instance.isUnlockHelper) {\r\n                    // 找树不隐藏：无论是否在区域内都显示\r\n                    this.createArrowPathTo(nearestTree.worldPosition);\r\n                    DataManager.Instance.arrow3DManager.node.active = true;\r\n                    DataManager.Instance.arrow3DManager.playFloatingEffect(deltaTime, nearestTree.worldPosition, false);\r\n\r\n                    DataManager.Instance.currentArrowPointing = nearestTree;\r\n                    this._lastArrowTarget = nearestTree;\r\n                    this.conditionalJudgment();\r\n                    return;\r\n                } else {\r\n                    this.setArrowCount(0);\r\n                    this._flowEnabled = false; // 停止流动\r\n                    DataManager.Instance.arrow3DManager.node.active = false;\r\n                    DataManager.Instance.currentArrowPointing = null;\r\n                    this._lastArrowTarget = null;\r\n                    return;\r\n                }\r\n            }\r\n        } else {\r\n            this.setArrowCount(0);\r\n            this._flowEnabled = false; // 停止流动\r\n            DataManager.Instance.arrow3DManager.node.active = false;\r\n            DataManager.Instance.currentArrowPointing = null;\r\n            this._lastArrowTarget = null;\r\n        }\r\n    }\r\n\r\n    private shouldHideForTarget(target: Node, isTree: boolean): boolean {\r\n        if (isTree) return false; // 找树不隐藏\r\n        if (!this.hideWhileInside) return false;\r\n\r\n        const targetChanged = target !== this._lastArrowTarget;\r\n        if (targetChanged) return false;\r\n\r\n        return this.isPlayerInsideTarget(target);\r\n    }\r\n\r\n    private isPlayerInsideTarget(target: Node | null): boolean {\r\n        const player = DataManager.Instance.player?.node;\r\n        if (!this.hideWhileInside || !player || !target || !target.isValid) return false;\r\n        return Vec3.distance(player.worldPosition, target.worldPosition) <= this.hideRadius;\r\n    }\r\n\r\n    private hideArrow() {\r\n        this._flowEnabled = false;  // 停止流动\r\n        this.setArrowCount(0);\r\n        if (DataManager.Instance.arrow3DManager?.node) {\r\n            DataManager.Instance.arrow3DManager.node.active = false;\r\n        }\r\n    }\r\n\r\n    // 查找背包物品\r\n    searchBackpackItem(typeItem: string) {\r\n        const playerNode = DataManager.Instance.player.node;\r\n        const backpack1 = playerNode.getChildByName('Backpack1');\r\n        const backpack2 = playerNode.getChildByName('Backpack2');\r\n        const backpack3 = playerNode.getChildByName('Backpack3');\r\n\r\n        const backpacks: Node[] = [backpack1, backpack2, backpack3].filter(Boolean) as Node[];\r\n        let sourceBackpack = this._findBackpackWithItem(backpacks, typeItem);\r\n\r\n        return sourceBackpack;\r\n    }\r\n\r\n    private _findBackpackWithItem(backpacks: Node[], typeItem: string): Node | null {\r\n        for (const bag of backpacks) {\r\n            if (bag.children.some(child => child.name.includes(typeItem))) {\r\n                return bag;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // 条件判断\r\n    conditionalJudgment() {\r\n        const player = DataManager.Instance.player.node;\r\n        if (DataManager.Instance.guideTargetIndex == -1) {\r\n            const backpack1 = player.getChildByName('Backpack1');\r\n            if (backpack1 && backpack1.children.length >= 5) {\r\n                DataManager.Instance.guideTargetIndex++;\r\n            }\r\n        }\r\n    }\r\n    /** 记录新路径、生成/排布箭头，并启动实时跟随 */\r\n    createArrowPathTo(targetPos: Vec3) {\r\n        const player = DataManager.Instance.player?.node;\r\n        if (!player) return;\r\n\r\n        player.getWorldPosition(this._pathStart);\r\n        this._pathEnd.set(targetPos);\r\n\r\n        Vec3.subtract(this._pathDir, this._pathEnd, this._pathStart);\r\n        this._pathLen = this._pathDir.length();\r\n\r\n        if (this._pathLen < 0.01) {\r\n            this.setArrowCount(0);\r\n            this._flowEnabled = false;\r\n            return;\r\n        }\r\n\r\n        this._pathDir.normalize();\r\n\r\n        // 固定间距推算数量\r\n        const spacing = Math.max(0.05, this.spacing || 0.5);\r\n        const totalCount = Math.max(2, Math.floor(this._pathLen / spacing) + 1);\r\n\r\n        // 不重置 _flowOffset（保持连续流动）\r\n        this.setArrowCount(totalCount);\r\n\r\n        // 首帧排一次\r\n        this._layoutArrows();\r\n        this._flowEnabled = true;\r\n    }\r\n\r\n    setArrowCount(targetCount: number) {\r\n        const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.PathArrow);\r\n        if (!prefab) return;\r\n\r\n        // 只在尾部增/删，已有索引不变 -> 不重排\r\n        while (this.arrowNodes.length < targetCount) {\r\n            const arrow = instantiate(prefab);\r\n            arrow.setParent(this.node);\r\n\r\n            this.arrowNodes.push(arrow);\r\n        }\r\n\r\n        while (this.arrowNodes.length > targetCount) {\r\n            const arrow = this.arrowNodes.pop()!;\r\n            arrow.destroy();\r\n        }\r\n    }\r\n\r\n    private _tickArrowFlow(dt: number) {\r\n        if (!this._flowEnabled || this.arrowNodes.length === 0) return;\r\n\r\n        const spacing = Math.max(0.05, this.spacing || 0.5);\r\n\r\n        const speed = Math.max(0.001, this.flowSpeed);\r\n        this._flowOffset += speed * dt;\r\n        this._flowOffset = ((this._flowOffset % spacing) + spacing) % spacing;\r\n\r\n        // 起点实时跟随人物脚下\r\n        const player = DataManager.Instance.player?.node;\r\n        if (!player) return;\r\n        player.getWorldPosition(this._pathStart);\r\n\r\n        // 重算方向与长度\r\n        Vec3.subtract(this._pathDir, this._pathEnd, this._pathStart);\r\n        this._pathLen = this._pathDir.length();\r\n        if (this._pathLen < 0.01) {\r\n            this.setArrowCount(0);\r\n            return;\r\n        }\r\n        this._pathDir.normalize();\r\n\r\n        // 根据最新长度按固定间距更新尾部数量\r\n        const needCount = Math.max(2, Math.floor(this._pathLen / spacing) + 1);\r\n        if (needCount !== this.arrowNodes.length) {\r\n            this.setArrowCount(needCount);\r\n        }\r\n\r\n        this._layoutArrows();\r\n    }\r\n\r\n    private _layoutArrows() {\r\n        const rot = new Quat();\r\n        Quat.fromViewUp(rot, this._pathDir, Vec3.UP);\r\n\r\n        const count = this.arrowNodes.length;\r\n        if (count <= 0 || this._pathLen < 0.0001) return;\r\n\r\n        const spacing = Math.max(0.05, this.spacing || 0.5);\r\n        const fadeInRange = spacing * 1.0;\r\n        const fadeOutRange = spacing * 1.2;\r\n        const NEWBORN_KEY = '__arrow_newborn__';\r\n\r\n        const base = new Vec3();\r\n        const pos = new Vec3();\r\n\r\n        const distInfos: { i: number; dToEnd: number }[] = [];\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            // let dist = (i === 0) ? 0 : (i - 1) * spacing + this._flowOffset;\r\n\r\n            let dist = i * spacing + this._flowOffset;\r\n\r\n            if (dist >= this._pathLen) dist = dist % this._pathLen;\r\n            else if (dist < 0) dist = (dist % this._pathLen + this._pathLen) % this._pathLen;\r\n\r\n            Vec3.multiplyScalar(base, this._pathDir, dist);\r\n            Vec3.add(pos, this._pathStart, base);\r\n            pos.y = this.arrowHeight;\r\n\r\n            const arrow = this.arrowNodes[i];\r\n            arrow.setWorldPosition(pos);\r\n            arrow.setWorldRotation(rot);\r\n\r\n\r\n            const ui = arrow.getComponent(UIOpacity) || arrow.addComponent(UIOpacity);\r\n\r\n            const isNewborn = !!(arrow as any)[NEWBORN_KEY];\r\n            if (isNewborn) {\r\n                if (dist <= fadeInRange) {\r\n                    const tIn = Math.max(0, Math.min(1, dist / fadeInRange));\r\n                    ui.opacity = Math.floor(255 * tIn);\r\n                    if (tIn >= 1) {\r\n                        // 走出淡入区后\r\n                        delete (arrow as any)[NEWBORN_KEY];\r\n                    }\r\n                } else {\r\n                    ui.opacity = 0; // 还没到脚下，保持不可见\r\n                }\r\n                continue;\r\n            }\r\n\r\n            let alpha = 255;\r\n\r\n            if (i !== 0 && dist <= fadeInRange) {\r\n                const tIn = Math.max(0, Math.min(1, dist / fadeInRange));\r\n                alpha = Math.min(alpha, Math.floor(255 * tIn));\r\n            }\r\n\r\n            const dToEnd = this._pathLen - dist;\r\n            if (dToEnd <= fadeOutRange) {\r\n                const tOut = Math.max(0, Math.min(1, dToEnd / fadeOutRange));\r\n                alpha = Math.min(alpha, Math.floor(255 * tOut));\r\n            }\r\n\r\n            distInfos.push({ i, dToEnd });\r\n            ui.opacity = alpha;\r\n        }\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const arrow = this.arrowNodes[i];\r\n            const ui = arrow.getComponent(UIOpacity) || arrow.addComponent(UIOpacity);\r\n            ui.opacity = 255;\r\n        }\r\n\r\n        distInfos.sort((a, b) => a.dToEnd - b.dToEnd);\r\n        const last3 = distInfos.slice(0, Math.min(3, distInfos.length));\r\n\r\n        const fades = [80, 140, 200];\r\n        for (let k = 0; k < last3.length; k++) {\r\n            const idx = last3[k].i;\r\n            const arrow = this.arrowNodes[idx];\r\n            const ui = arrow.getComponent(UIOpacity) || arrow.addComponent(UIOpacity);\r\n            ui.opacity = fades[k];\r\n        }\r\n    }\r\n    // 动态获取离主角最近的树\r\n    getNearTree(player: Node): Node | null {\r\n        if (DataManager.Instance.treeMatrix.length <= 0) return null;\r\n\r\n        const treeMRow = DataManager.Instance.treeMatrix.length;\r\n        const treeMCol = DataManager.Instance.treeMatrix[0].length;\r\n        for (let c = treeMCol - 1; c >= 0; c--) {\r\n            for (let r = 0; r < treeMRow; r++) {\r\n                const treeNode = DataManager.Instance.treeMatrix[r][c];\r\n                if (treeNode) {\r\n                    return treeNode;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n}\r\n"]}