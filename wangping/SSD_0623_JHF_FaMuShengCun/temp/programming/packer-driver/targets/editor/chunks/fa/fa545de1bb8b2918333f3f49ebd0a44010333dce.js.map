{"version":3,"sources":["file:///D:/Cocos/PlayAble/SSD_0623_JHF_FaMuShengCun/assets/JavaScript/Placing/WoodAccumulationConManager.ts"],"names":["_decorator","Component","Node","tween","Vec3","Animation","StackManager","DataManager","SoundManager","ccclass","property","WoodAccumulationConManager","_row","_col","_gapX","_gapY","_gapZ","_maxLayer","_isProcessing","start","node","update","deltaTime","Instance","isContinueFillFireWood","active","children","length","wood","getTopItem","isValid","_processWood","startPos","getWorldPosition","endPos","cutterStart","worldPosition","clone","startRot","eulerAngles","endRot","controlPoint","x","Math","max","y","z","level","conveyorLevel","tParam","t","curQuantityFirewood","to","easing","onUpdate","_updateBezierMovement","onComplete","_onBezierComplete","oneMinusT","pos","setWorldPosition","euler","moveStart","moveEnd","cutterEnd","moveParam","_onMoveComplete","chainsawNode","inst","playAudio","removeFromParent","boardManager","boardAni","conveyerBeltStart","conveyerBeltEnd","stackManager","lastSlot","getLastOccupiedSlot","assignedNode","releaseSlot","getMidPoint","p0","p2","peakOffsetY"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, tween, Vec3, Animation } from 'cc';\r\nimport { StackManager } from '../StackSlot/StackManager';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { SoundManager } from '../Common/SoundManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WoodAccumulationConManager')\r\nexport class WoodAccumulationConManager extends Component {\r\n    // 电锯火光特效\r\n    @property(Node)\r\n    chainsawNode: Node = null;\r\n\r\n    @property(Node)\r\n    cutterStart: Node = null;\r\n\r\n    @property(Node)\r\n    cutterEnd: Node = null;\r\n\r\n    @property(Node)\r\n    conveyerBeltStart: Node = null;\r\n\r\n    @property(Node)\r\n    conveyerBeltEnd: Node = null;\r\n\r\n    @property(Node)\r\n    cameraPos: Node = null;\r\n\r\n    @property(Animation)\r\n    logging: Animation = null;\r\n\r\n\r\n    private _row = 2;\r\n    private _col = 7;\r\n    private _gapX = 0.7;\r\n    private _gapY = 2;\r\n    private _gapZ = 0.7;\r\n    private _maxLayer = 20000;\r\n\r\n    private _isProcessing = false;\r\n\r\n    start() {\r\n        if (this.node && !this.node[`__stackManager`]) {\r\n            this.node[`__stackManager`] = new StackManager(this._row, this._col, this._gapX, this._gapY, this._gapZ, this._maxLayer);\r\n        }\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n        if (!DataManager.Instance.isContinueFillFireWood) return;\r\n        if (!this.node?.active || this._isProcessing || this.node.children.length <= 0) return;\r\n\r\n        const wood = this.getTopItem();\r\n        if (!wood?.isValid) return;\r\n\r\n        this._isProcessing = true;\r\n        this._processWood(wood);\r\n    }\r\n\r\n    private _processWood(wood: Node) {\r\n        const startPos = wood.getWorldPosition();\r\n        const endPos = this.cutterStart.worldPosition.clone();\r\n        const startRot = wood.eulerAngles.clone();\r\n        const endRot = new Vec3(0, 0, -90);\r\n\r\n        const controlPoint = new Vec3(\r\n            (startPos.x + endPos.x) / 2,\r\n            Math.max(startPos.y, endPos.y) + 15,\r\n            (startPos.z + endPos.z) / 2\r\n        );\r\n\r\n        const level: number = DataManager.Instance.conveyorLevel;\r\n        const tParam = { t: 0 };\r\n\r\n        DataManager.Instance.curQuantityFirewood++;\r\n\r\n        tween(tParam)\r\n            .to(0.6 / level, { t: 1 }, {\r\n                easing: 'quadOut',\r\n                onUpdate: () => this._updateBezierMovement(wood, startPos, controlPoint, endPos, startRot, endRot, tParam.t),\r\n                onComplete: () => this._onBezierComplete(wood, endRot)\r\n            })\r\n            .start();\r\n    }\r\n\r\n    private _updateBezierMovement(wood: Node, startPos: Vec3, controlPoint: Vec3, endPos: Vec3, startRot: Vec3, endRot: Vec3, t: number) {\r\n        const oneMinusT = 1 - t;\r\n\r\n        // 三次贝塞尔插值位置\r\n        const pos = new Vec3(\r\n            oneMinusT * oneMinusT * startPos.x + 2 * oneMinusT * t * controlPoint.x + t * t * endPos.x,\r\n            oneMinusT * oneMinusT * startPos.y + 2 * oneMinusT * t * controlPoint.y + t * t * endPos.y,\r\n            oneMinusT * oneMinusT * startPos.z + 2 * oneMinusT * t * controlPoint.z + t * t * endPos.z\r\n        );\r\n        wood.setWorldPosition(pos);\r\n\r\n        // 欧拉角插值\r\n        const euler = new Vec3(\r\n            startRot.x * oneMinusT + endRot.x * t,\r\n            startRot.y * oneMinusT + endRot.y * t,\r\n            startRot.z * oneMinusT + endRot.z * t\r\n        );\r\n        wood.eulerAngles = euler;\r\n    }\r\n\r\n    private _onBezierComplete(wood: Node, endRot: Vec3) {\r\n        wood.eulerAngles = endRot;\r\n\r\n        const moveStart = wood.getWorldPosition();\r\n        const moveEnd = this.cutterEnd.worldPosition.clone();\r\n        // const level: number = DataManager.Instance.conveyorLevel;\r\n        const moveParam = { t: 0 };\r\n        // / level\r\n        tween(moveParam)\r\n            .to(0.2, { t: 1 }, {\r\n                easing: 'quadInOut',\r\n                onUpdate: () => {\r\n                    const t = moveParam.t;\r\n                    const pos = new Vec3(\r\n                        moveStart.x + (moveEnd.x - moveStart.x) * t,\r\n                        moveStart.y + (moveEnd.y - moveStart.y) * t,\r\n                        moveStart.z + (moveEnd.z - moveStart.z) * t\r\n                    );\r\n                    wood.setWorldPosition(pos);\r\n                },\r\n                onComplete: () => this._onMoveComplete(wood)\r\n            })\r\n            .start();\r\n\r\n        if (this.chainsawNode) this.chainsawNode.active = true;\r\n        SoundManager.inst.playAudio('Sounds_jumutou');\r\n    }\r\n\r\n    private _onMoveComplete(wood: Node) {\r\n        if (wood?.isValid) {\r\n            wood.removeFromParent();\r\n            // DataManager.Instance.woodManager.onWoodDead(wood); // 如需放回对象池\r\n        }\r\n\r\n        this._isProcessing = false;\r\n        if (this.chainsawNode) this.chainsawNode.active = false;\r\n        DataManager.Instance.boardManager.boardAni(this.conveyerBeltStart, this.conveyerBeltEnd);\r\n        // this.logging.pause();\r\n    }\r\n\r\n\r\n    private getTopItem(): Node | null {\r\n        const stackManager: StackManager = this.node[\"__stackManager\"];\r\n        const lastSlot = stackManager.getLastOccupiedSlot();\r\n        const node = lastSlot?.assignedNode || null;\r\n        if (node) stackManager.releaseSlot(node);\r\n        return node;\r\n    }\r\n\r\n    private getMidPoint(p0: Vec3, p2: Vec3, peakOffsetY: number): Vec3 {\r\n        return new Vec3(\r\n            (p0.x + p2.x) / 2,\r\n            Math.max(p0.y, p2.y) + peakOffsetY,\r\n            (p0.z + p2.z) / 2\r\n        );\r\n    }\r\n}\r\n\r\n\r\n"]}