{"version":3,"sources":["file:///D:/Cocos/PlayAble/SSD_PullWire/assets/JavaScript/core/MapFarmland.ts"],"names":["_decorator","Component","Node","SkeletalAnimation","Animation","warn","tween","Vec3","eventMgr","EventType","PalingAnimation","FruitScript","DataManager","coinEffect","CloudParticleEffect","ccclass","property","MapFarmland","coinNum","mapCoinNum","isStart","_fruitScripts","_palingAnimations","_animations","_skeletalAnimations","_updateTimer","_checkInterval","_fruitStateChange","_coinEffectPool","onInitEvent","on","MapFarmland_cloudFadeOut","cloudFadeOutCallBack","MapFarmland_cloudFadeIn","cloudFadeInCallBack","MapFarmland_fruitGreen","fruitGreenCallBack","MapFarmland_start","FarmlandCallBack","Lumberyard_start","lumberyardStart","onLoad","initPaling","_cacheComponents","start","animState","palingAnimation","getState","defaultClip","name","time","sample","pause","levelUp","getComponent","levelUpParticle","particleEffect","rotator","rotatorNode","_cacheFruitScripts","fruitParent","length","children","forEach","child","fruitNode","getChildByName","script","push","Instance","Arrow_farmLand","active","soundManager","playSocketSound","scheduleOnce","addCoin","playElectricSound","playLockSound","palingEffctCallBack","allEffect","mapEffct","play","once","FINISHED","playUpgradeSound","playCheerSound","playWateringSoundThreeTimes","_playCoinEffect","mapCoinNode","emit","mainCamera","node","to","worldPosition","call","cloudParticleOuter","cloudFadeEffct","cloudParticleCentrality","palingEffctTo","right","startMoveDown","Promise","all","up","startAnimation","down","playPalingSound","playGrowSound","setFruitState","fruitRedCallBack","randomIndex","Math","floor","random","coinNode","parent","update","deltaTime","isGameOver","palingUp","effect","addComponent","setCoinNum","playEffect","onDestroy","unscheduleAllCallbacks"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,I,OAAAA,I;AAAcC,MAAAA,iB,OAAAA,iB;AAAmBC,MAAAA,S,OAAAA,S;AAAgCC,MAAAA,I,OAAAA,I;AAA6BC,MAAAA,K,OAAAA,K;AAAOC,MAAAA,I,OAAAA,I;;AAC5HC,MAAAA,Q,iBAAAA,Q;;AACAC,MAAAA,S,iBAAAA,S;;AAEAC,MAAAA,e,iBAAAA,e;;AACAC,MAAAA,W,iBAAAA,W;;AAGAC,MAAAA,W,iBAAAA,W;;AACAC,MAAAA,U,iBAAAA,U;;AACAC,MAAAA,mB,iBAAAA,mB;;;;;;;;;OAEH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBhB,U;;6BAGjBiB,W,WADZF,OAAO,CAAC,aAAD,C,UAGHC,QAAQ,CAACd,IAAD,C,UAGRc,QAAQ,CAACd,IAAD,C,UAERc,QAAQ,CAACd,IAAD,C,UAERc,QAAQ,CAACd,IAAD,C,UAERc,QAAQ,CAACd,IAAD,C,UAGRc,QAAQ,CAACd,IAAD,C,UAERc,QAAQ,CAACd,IAAD,C,UAMRc,QAAQ,CAACd,IAAD,C,WAGRc,QAAQ,CAACd,IAAD,C,WAERc,QAAQ,CAACd,IAAD,C,WAERc,QAAQ,CAACd,IAAD,C,WAGRc,QAAQ,CAACZ,SAAD,C,WAIRY,QAAQ;AAAA;AAAA,qD,WAGRA,QAAQ;AAAA;AAAA,qD,WAGRA,QAAQ,CAACZ,SAAD,C,2BA3Cb,MACaa,WADb,SACiChB,SADjC,CAC2C;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAmB/BiB,OAnB+B,GAmBb,EAnBa;AAAA,eAoB/BC,UApB+B,GAoBV,GApBU;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAkC/BC,OAlC+B,GAkCZ,KAlCY;;AAAA;;AAAA;;AAAA;;AA6CvC;AA7CuC,eA8C/BC,aA9C+B,GA8CA,EA9CA;AAAA,eA+C/BC,iBA/C+B,GA+CsB,EA/CtB;AAAA,eAgD/BC,WAhD+B,GAgDU,EAhDV;AAAA,eAiD/BC,mBAjD+B,GAiD0B,EAjD1B;AAmDvC;AAnDuC,eAoD/BC,YApD+B,GAoDR,CApDQ;AAAA,eAqD/BC,cArD+B,GAqDN,CArDM;AAqDH;AArDG,eAsD/BC,iBAtD+B,GAsDF,KAtDE;AAwDvC;AAxDuC,eAyD/BC,eAzD+B,GAyDC,EAzDD;AAAA;;AA2DvCC,QAAAA,WAAW,GAAG;AACV;AAAA;AAAA,oCAASC,EAAT,CAAY;AAAA;AAAA,sCAAUC,wBAAtB,EAAgD,KAAKC,oBAArD,EAA2E,IAA3E;AACA;AAAA;AAAA,oCAASF,EAAT,CAAY;AAAA;AAAA,sCAAUG,uBAAtB,EAA+C,KAAKC,mBAApD,EAAyE,IAAzE;AACA;AAAA;AAAA,oCAASJ,EAAT,CAAY;AAAA;AAAA,sCAAUK,sBAAtB,EAA8C,KAAKC,kBAAnD,EAAuE,IAAvE;AACA;AAAA;AAAA,oCAASN,EAAT,CAAY;AAAA;AAAA,sCAAUO,iBAAtB,EAAyC,KAAKC,gBAA9C,EAAgE,IAAhE;AACA;AAAA;AAAA,oCAASR,EAAT,CAAY;AAAA;AAAA,sCAAUS,gBAAtB,EAAwC,KAAKC,eAA7C,EAA8D,IAA9D;AACH;;AAEDC,QAAAA,MAAM,GAAS;AACX,eAAKZ,WAAL;AACA,eAAKa,UAAL;;AACA,eAAKC,gBAAL;AACH;;AACSC,QAAAA,KAAK,GAAS;AACpB,cAAMC,SAAS,GAAG,KAAKC,eAAL,CAAqBC,QAArB,CAA8B,KAAKD,eAAL,CAAqBE,WAArB,CAAiCC,IAA/D,CAAlB;;AACA,cAAIJ,SAAJ,EAAe;AACXA,YAAAA,SAAS,CAACK,IAAV,GAAiB,CAAjB,CADW,CACY;;AACvBL,YAAAA,SAAS,CAACM,MAAV,GAFW,CAEY;;AACvB,iBAAKL,eAAL,CAAqBM,KAArB,GAHW,CAGmB;AACjC;AACJ,SA/EsC,CAiFvC;;;AACQT,QAAAA,gBAAgB,GAAG;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA,eAAKpB,WAAL,GAAmB;AAEf8B,YAAAA,OAAO,EAAE,KAAKA,OAAL,CAAaC,YAAb,CAA0BlD,SAA1B,CAFM;AAGfmD,YAAAA,eAAe,EAAE,KAAKA,eAAL,CAAqBD,YAArB,CAAkClD,SAAlC,CAHF;AAIfoD,YAAAA,cAAc,EAAE,KAAKA,cAAL,CAAoBF,YAApB,CAAiClD,SAAjC;AAJD,WAAnB,CAVuB,CAiBvB;;AACA,eAAKoB,mBAAL,CAAyBiC,OAAzB,GAAmC,KAAKC,WAAL,CAAiBJ,YAAjB,CAA8BnD,iBAA9B,CAAnC,CAlBuB,CAoBvB;;AACA,eAAKwD,kBAAL;AACH,SAxGsC,CA0GvC;;;AACQA,QAAAA,kBAAkB,GAAG;AACzB,cAAI,CAAC,KAAKC,WAAV,EAAuB;AAEvB,eAAKvC,aAAL,CAAmBwC,MAAnB,GAA4B,CAA5B;AACA,eAAKD,WAAL,CAAiBE,QAAjB,CAA0BC,OAA1B,CAAkCC,KAAK,IAAI;AACvC,gBAAMC,SAAS,GAAGD,KAAK,CAACE,cAAN,CAAqB,WAArB,CAAlB;;AACA,gBAAID,SAAJ,EAAe;AACX,kBAAME,MAAM,GAAGF,SAAS,CAACX,YAAV;AAAA;AAAA,6CAAf;AACA,kBAAIa,MAAJ,EAAY,KAAK9C,aAAL,CAAmB+C,IAAnB,CAAwBD,MAAxB;AACf;AACJ,WAND;AAOH;;AAED7B,QAAAA,gBAAgB,GAAG;AACf;AAAA;AAAA,0CAAY+B,QAAZ,CAAqBC,cAArB,CAAoCC,MAApC,GAA6C,KAA7C;AACA;AAAA;AAAA,0CAAYF,QAAZ,CAAqBG,YAArB,CAAkCC,eAAlC;AACA,eAAKC,YAAL,CAAkB,MAAM;AACpB;AAAA;AAAA,4CAAYL,QAAZ,CAAqBM,OAArB,CAA6B,KAAKxD,UAAlC;AACH,WAFD,EAEG,GAFH;AAGA,cAAI,KAAKC,OAAT,EAAkB;AAClB,eAAKsD,YAAL,CAAkB,MAAM;AACpB;AAAA;AAAA,4CAAYL,QAAZ,CAAqBG,YAArB,CAAkCI,iBAAlC;AACA;AAAA;AAAA,4CAAYP,QAAZ,CAAqBG,YAArB,CAAkCK,aAAlC;AACH,WAHD,EAGG,GAHH,EAPe,CAaf;;AACA,eAAKC,mBAAL,GAde,CAef;AAEH;;AACDC,QAAAA,SAAS,GAAG;AACR,eAAKC,QAAL,CAAcC,IAAd;AACA,eAAK7D,OAAL,GAAe,IAAf,CAFQ,CAIR;;AACA,eAAKiC,OAAL,CAAakB,MAAb,GAAsB,IAAtB;;AACA,eAAKhD,WAAL,CAAiB8B,OAAjB,CAAyB4B,IAAzB;;AACA,eAAK1D,WAAL,CAAiB8B,OAAjB,CAAyB6B,IAAzB,CAA8B9E,SAAS,CAACK,SAAV,CAAoB0E,QAAlD,EAA4D,MAAM;AAC9D,iBAAK9B,OAAL,CAAakB,MAAb,GAAsB,KAAtB;AACH,WAFD,EAEG,IAFH;;AAKA;AAAA;AAAA,0CAAYF,QAAZ,CAAqBG,YAArB,CAAkCY,gBAAlC,GAZQ,CAcR;;AACA,eAAK7B,eAAL,CAAqBgB,MAArB,GAA8B,IAA9B;AACA,eAAKG,YAAL,CAAkB,MAAM;AACpB,iBAAKnD,WAAL,CAAiBgC,eAAjB,CAAiC0B,IAAjC;AACH,WAFD,EAEG,IAFH,EAhBQ,CAmBR;;AACA,eAAK1D,WAAL,CAAiBgC,eAAjB,CAAiC2B,IAAjC,CAAsC9E,SAAS,CAACK,SAAV,CAAoB0E,QAA1D,EAAoE,MAAM;AACtE,iBAAK5B,eAAL,CAAqBgB,MAArB,GAA8B,KAA9B,CADsE,CAGtE;;AACA,iBAAK/C,mBAAL,CAAyBiC,OAAzB,CAAiCwB,IAAjC,GAJsE,CAKtE;;;AACA,iBAAKzB,cAAL,CAAoBe,MAApB,GAA6B,IAA7B;;AACA,iBAAKhD,WAAL,CAAiBiC,cAAjB,CAAgCyB,IAAhC;;AACA,iBAAKP,YAAL,CAAkB,MAAM;AACpB;AAAA;AAAA,8CAAYL,QAAZ,CAAqBG,YAArB,CAAkCa,cAAlC;AACH,aAFD,EAEG,GAFH;AAIA;AAAA;AAAA,4CAAYhB,QAAZ,CAAqBG,YAArB,CAAkCc,2BAAlC;AAEH,WAdD,EAcG,IAdH;;AAeA,eAAKZ,YAAL,CAAkB,MAAM;AACpB,iBAAKa,eAAL,CAAqB,KAAKC,WAA1B,EAAuC,KAAKrE,UAA5C;AAEH,WAHD,EAGG,GAHH;AAIA,eAAKuD,YAAL,CAAkB,MAAM;AACpB;AAAA;AAAA,sCAASe,IAAT,CAAc;AAAA;AAAA,wCAAUtD,sBAAxB;AACH,WAFD,EAEG,GAFH;AAGA,eAAKuC,YAAL,CAAkB,MAAM;AACpB;AACApE,YAAAA,KAAK,CAAC;AAAA;AAAA,4CAAY+D,QAAZ,CAAqBqB,UAArB,CAAgCC,IAAjC,CAAL,CACKC,EADL,CACQ,GADR,EACa;AAAEC,cAAAA,aAAa,EAAE,IAAItF,IAAJ,CAAS,QAAT,EAAmB,IAAnB,EAAyB,SAAzB;AAAjB,aADb,EAEKuF,IAFL,CAEU,MAAM,CACR;AACH,aAJL,EAKKlD,KALL;AAOH,WATD,EASG,GATH;AAUH;;AACDZ,QAAAA,oBAAoB,GAAG;AACnB,cAAI,KAAKZ,OAAT,EAAkB;AAClB,eAAK2E,kBAAL,CAAwBC,cAAxB,CAAuC,KAAvC;AACA,eAAKC,uBAAL,CAA6BD,cAA7B,CAA4C,KAA5C,EAHmB,CAMnB;AACA;AACA;AAEH;;AAED9D,QAAAA,mBAAmB,GAAG;AAClB,cAAI,KAAKd,OAAT,EAAkB;AAClB,eAAK2E,kBAAL,CAAwBC,cAAxB,CAAuC,IAAvC;AACA,eAAKC,uBAAL,CAA6BD,cAA7B,CAA4C,IAA5C,EAHkB,CAIlB;AACH;;AAEDtD,QAAAA,UAAU,GAAG,CACT;AACA;AACA;AACA;AAEH;;AAEKwD,QAAAA,aAAa,GAAG;AAAA;;AAAA;AAClB,YAAA,KAAI,CAAC5E,iBAAL,CAAuB6E,KAAvB,CAA6BC,aAA7B;;AACA,kBAAMC,OAAO,CAACC,GAAR,CAAY,CACd,KAAI,CAAChF,iBAAL,CAAuBiF,EAAvB,CAA0BC,cAA1B,EADc,EAEd,KAAI,CAAClF,iBAAL,CAAuBmF,IAAvB,CAA4BD,cAA5B,EAFc,CAAZ,CAAN;AAFkB;AAMrB;;AAEK1B,QAAAA,mBAAmB,GAAG;AAAA;;AAAA;AACxB;AACA;AACA;AACA;AAEA,YAAA,MAAI,CAAChC,eAAL,CAAqBmC,IAArB;;AACA,YAAA,MAAI,CAACP,YAAL,CAAkB,MAAM;AACpB,cAAA,MAAI,CAACK,SAAL;AACH,aAFD,EAEG,IAFH;;AAGA,YAAA,MAAI,CAACjC,eAAL,CAAqBoC,IAArB,CAA0B9E,SAAS,CAACK,SAAV,CAAoB0E,QAA9C,EAAwD,MAAM,CAG7D,CAHD,EAGG,MAHH;;AAIA;AAAA;AAAA,4CAAYd,QAAZ,CAAqBG,YAArB,CAAkCkC,eAAlC,GAdwB,CAexB;AAEA;AAjBwB;AAkB3B;;AAEDtE,QAAAA,kBAAkB,GAAG;AACjB;AAAA;AAAA,0CAAYiC,QAAZ,CAAqBG,YAArB,CAAkCmC,aAAlC;;AACA,eAAKtF,aAAL,CAAmB0C,OAAnB,CAA2BI,MAAM,IAAI;AACjCA,YAAAA,MAAM,CAACyC,aAAP,CAAqB,KAArB,EADiC,CACL;AAC/B,WAFD;;AAGA,eAAKjF,iBAAL,GAAyB,IAAzB;AACA,eAAKF,YAAL,GAAoB,CAApB;AACH;;AAEDoF,QAAAA,gBAAgB,GAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA,cAAMC,WAAW,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgB,KAAK5F,aAAL,CAAmBwC,MAA9C,CAApB,CAXe,CAYf;AACA;;AAEA;AAAA;AAAA,0CAAYQ,QAAZ,CAAqBM,OAArB,CAA6B,KAAKzD,OAAlC,EAfe,CAiBf;;AACA,cAAMgG,QAAQ,GAAG,KAAK7F,aAAL,CAAmByF,WAAnB,EAAgCnB,IAAhC,CAAqCwB,MAArC,CAA4CjD,cAA5C,CAA2D,UAA3D,CAAjB;;AACA,cAAIgD,QAAJ,EAAc;AACV,iBAAKxC,YAAL,CAAkB,MAAM;AACpB,mBAAKa,eAAL,CAAqB2B,QAArB,EAA+B,KAAKhG,OAApC;AACH,aAFD,EAEG,GAFH;AAGH,WAJD,MAIO;AACHb,YAAAA,IAAI,CAAC,eAAD,EAAkByG,WAAlB,CAAJ;AACH,WAzBc,CA2Bf;AACA;AACA;;;AAEA,eAAKrF,YAAL,GAAoB,CAApB;AACH,SA/RsC,CAiSvC;;;AACA2F,QAAAA,MAAM,CAACC,SAAD,EAAoB;AACtB,cAAI,CAAC,KAAK1F,iBAAV,EAA6B;AAE7B,eAAKF,YAAL,IAAqB4F,SAArB;;AACA,cAAI,KAAK5F,YAAL,IAAqB,KAAKC,cAA9B,EAA8C;AAC1C,iBAAKmF,gBAAL;AACA,iBAAKpF,YAAL,GAAoB,CAApB;AACH;AACJ;;AAEDe,QAAAA,eAAe,GAAG;AACd,cAAI;AAAA;AAAA,0CAAY6B,QAAZ,CAAqBiD,UAAzB,EAAqC;AACjC,iBAAK5C,YAAL,CAAkB,MAAM;AACpB;AACA,mBAAK6C,QAAL,CAAcjE,YAAd;AAAA;AAAA,sDAA4C8C,aAA5C;AACH,aAHD,EAGG,CAHH;AAIH;AACJ,SAnTsC,CAqTvC;;;AACQb,QAAAA,eAAe,CAACI,IAAD,EAAazE,OAAb,EAA8B;AACjD,cAAI,CAACyE,IAAL,EAAW;AAEX,cAAI6B,MAAM,GAAG7B,IAAI,CAACrC,YAAL;AAAA;AAAA,uCAAb;;AACA,cAAI,CAACkE,MAAL,EAAa;AACTA,YAAAA,MAAM,GAAG7B,IAAI,CAAC8B,YAAL;AAAA;AAAA,yCAAT;AACH;;AAEDD,UAAAA,MAAM,CAACE,UAAP,CAAkBxG,OAAlB;AACAsG,UAAAA,MAAM,CAACG,UAAP;AACH;;AAEDC,QAAAA,SAAS,GAAG;AACR;AACA;AAEA;AACA,eAAKC,sBAAL;AACH;;AAxUsC,O;;;;;iBAGV,I;;;;;;;iBAGC,I;;;;;;;iBAED,I;;;;;;;iBAEF,I;;;;;;;iBAEE,I;;;;;;;iBAGT,I;;;;;;;iBAEA,I;;;;;;;iBAMJ,I;;;;;;;iBAGQ,I;;;;;;;iBAED,I;;;;;;;iBAEH,I;;;;;;;iBAGE,I;;;;;;;iBAIoB,I;;;;;;;iBAGK,I;;;;;;;iBAGlB,I","sourcesContent":["import { _decorator, Component, Node, Prefab, SkeletalAnimation, Animation, ConeCollider, error, warn, ParticleSystem, Color, tween, Vec3 } from 'cc';\r\nimport { eventMgr } from './EventManager';\r\nimport { EventType } from './EventType';\r\nimport { CloudEffct } from './CloudEffct';\r\nimport { PalingAnimation } from './PalingAnimation';\r\nimport { FruitScript } from './FruitScript';\r\nimport { NodeRotator } from './NodeRotator';\r\nimport { GroundParent } from './GroundParent';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { coinEffect } from './coinEffect';\r\nimport { CloudParticleEffect } from './CloudParticleEffect';\r\nimport { SoundManager } from './SoundManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('MapFarmland')\r\nexport class MapFarmland extends Component {\r\n\r\n    @property(Node)\r\n    protected palingNode: Node = null;\r\n\r\n    @property(Node)\r\n    protected palingRight: Node = null;\r\n    @property(Node)\r\n    protected palingLeft: Node = null;\r\n    @property(Node)\r\n    protected palingUp: Node = null;\r\n    @property(Node)\r\n    protected palingDown: Node = null;\r\n\r\n    @property(Node)\r\n    fruitParent: Node = null;\r\n    @property(Node)\r\n    rotatorNode: Node = null;\r\n\r\n    private coinNum: number = 10;\r\n    private mapCoinNum: number = 300;\r\n\r\n    @property(Node)\r\n    levelUp: Node = null;\r\n\r\n    @property(Node)\r\n    levelUpParticle: Node = null;\r\n    @property(Node)\r\n    particleEffect: Node = null;\r\n    @property(Node)\r\n    mapCoinNode: Node = null;\r\n\r\n    @property(Animation)\r\n    mapEffct: Animation = null;\r\n    private isStart: boolean = false;\r\n\r\n    @property(CloudParticleEffect)\r\n    cloudParticleOuter: CloudParticleEffect = null;\r\n\r\n    @property(CloudParticleEffect)\r\n    cloudParticleCentrality: CloudParticleEffect = null;\r\n\r\n    @property(Animation)\r\n    palingAnimation: Animation = null;\r\n\r\n    // 缓存组件引用，避免重复查找\r\n    private _fruitScripts: FruitScript[] = [];\r\n    private _palingAnimations: Record<string, PalingAnimation> = {};\r\n    private _animations: Record<string, Animation> = {};\r\n    private _skeletalAnimations: Record<string, SkeletalAnimation> = {};\r\n\r\n    // 计时器优化\r\n    private _updateTimer: number = 0;\r\n    private _checkInterval: number = 2; // 检查间隔时间（秒）\r\n    private _fruitStateChange: boolean = false;\r\n\r\n    // 对象池相关\r\n    private _coinEffectPool: coinEffect[] = [];\r\n\r\n    onInitEvent() {\r\n        eventMgr.on(EventType.MapFarmland_cloudFadeOut, this.cloudFadeOutCallBack, this);\r\n        eventMgr.on(EventType.MapFarmland_cloudFadeIn, this.cloudFadeInCallBack, this);\r\n        eventMgr.on(EventType.MapFarmland_fruitGreen, this.fruitGreenCallBack, this);\r\n        eventMgr.on(EventType.MapFarmland_start, this.FarmlandCallBack, this);\r\n        eventMgr.on(EventType.Lumberyard_start, this.lumberyardStart, this);\r\n    }\r\n\r\n    onLoad(): void {\r\n        this.onInitEvent();\r\n        this.initPaling();\r\n        this._cacheComponents();\r\n    }\r\n    protected start(): void {\r\n        const animState = this.palingAnimation.getState(this.palingAnimation.defaultClip.name);\r\n        if (animState) {\r\n            animState.time = 0;    // 设置到第一帧\r\n            animState.sample();    // 采样当前时间帧\r\n            this.palingAnimation.pause(); // 暂停动画，停留在第一帧\r\n        }\r\n    }\r\n\r\n    // 缓存常用组件引用\r\n    private _cacheComponents() {\r\n        // // 缓存栅栏动画组件\r\n        // this._palingAnimations = {\r\n        //     up: this.palingUp.getComponent(PalingAnimation),\r\n        //     down: this.palingDown.getComponent(PalingAnimation),\r\n        //     left: this.palingLeft.getComponent(PalingAnimation),\r\n        //     right: this.palingRight.getComponent(PalingAnimation)\r\n        // };\r\n\r\n        // 缓存动画组件\r\n        this._animations = {\r\n\r\n            levelUp: this.levelUp.getComponent(Animation),\r\n            levelUpParticle: this.levelUpParticle.getComponent(Animation),\r\n            particleEffect: this.particleEffect.getComponent(Animation)\r\n        };\r\n\r\n        // 缓存骨骼动画组件\r\n        this._skeletalAnimations.rotator = this.rotatorNode.getComponent(SkeletalAnimation);\r\n\r\n        // 缓存果实脚本\r\n        this._cacheFruitScripts();\r\n    }\r\n\r\n    // 缓存果实脚本引用\r\n    private _cacheFruitScripts() {\r\n        if (!this.fruitParent) return;\r\n\r\n        this._fruitScripts.length = 0;\r\n        this.fruitParent.children.forEach(child => {\r\n            const fruitNode = child.getChildByName(\"fruitNode\");\r\n            if (fruitNode) {\r\n                const script = fruitNode.getComponent(FruitScript);\r\n                if (script) this._fruitScripts.push(script);\r\n            }\r\n        });\r\n    }\r\n\r\n    FarmlandCallBack() {\r\n        DataManager.Instance.Arrow_farmLand.active = false;\r\n        DataManager.Instance.soundManager.playSocketSound();\r\n        this.scheduleOnce(() => {\r\n            DataManager.Instance.addCoin(this.mapCoinNum);\r\n        }, 0.3)\r\n        if (this.isStart) return;\r\n        this.scheduleOnce(() => {\r\n            DataManager.Instance.soundManager.playElectricSound();\r\n            DataManager.Instance.soundManager.playLockSound();\r\n        }, 0.6)\r\n\r\n\r\n        // this.scheduleOnce(() => {\r\n        this.palingEffctCallBack()\r\n        //}, 0.48)\r\n\r\n    }\r\n    allEffect() {\r\n        this.mapEffct.play();\r\n        this.isStart = true;\r\n\r\n        //升级光效\r\n        this.levelUp.active = true;\r\n        this._animations.levelUp.play();\r\n        this._animations.levelUp.once(Animation.EventType.FINISHED, () => {\r\n            this.levelUp.active = false;\r\n        }, this);\r\n\r\n\r\n        DataManager.Instance.soundManager.playUpgradeSound();\r\n\r\n        //升级粒子特效\r\n        this.levelUpParticle.active = true;\r\n        this.scheduleOnce(() => {\r\n            this._animations.levelUpParticle.play();\r\n        }, 0.06)\r\n        //this._animations.levelUpParticle.play();\r\n        this._animations.levelUpParticle.once(Animation.EventType.FINISHED, () => {\r\n            this.levelUpParticle.active = false;\r\n\r\n            //建筑旋转特效\r\n            this._skeletalAnimations.rotator.play();\r\n            //洒水粒子特效\r\n            this.particleEffect.active = true;\r\n            this._animations.particleEffect.play();\r\n            this.scheduleOnce(() => {\r\n                DataManager.Instance.soundManager.playCheerSound();\r\n            }, 0.2)\r\n\r\n            DataManager.Instance.soundManager.playWateringSoundThreeTimes()\r\n\r\n        }, this);\r\n        this.scheduleOnce(() => {\r\n            this._playCoinEffect(this.mapCoinNode, this.mapCoinNum);\r\n\r\n        }, 0.3)\r\n        this.scheduleOnce(() => {\r\n            eventMgr.emit(EventType.MapFarmland_fruitGreen);\r\n        }, 1.1);\r\n        this.scheduleOnce(() => {\r\n            //摄像机移动\r\n            tween(DataManager.Instance.mainCamera.node)\r\n                .to(0.8, { worldPosition: new Vec3(0.014142, 34.1, 37.250385) })\r\n                .call(() => {\r\n                    //this._upgraded = true;\r\n                })\r\n                .start();\r\n\r\n        }, 1.2)\r\n    }\r\n    cloudFadeOutCallBack() {\r\n        if (this.isStart) return;\r\n        this.cloudParticleOuter.cloudFadeEffct(false);\r\n        this.cloudParticleCentrality.cloudFadeEffct(false);\r\n\r\n\r\n        // const color = new Color(255, 255, 255, 0);  \r\n        // this.cloudParticleOuter.getMaterialInstance(0).setProperty(\"tintColor\",color);\r\n        // this.cloudParticleCentrality.getMaterialInstance(0).setProperty(\"tintColor\",color);\r\n\r\n    }\r\n\r\n    cloudFadeInCallBack() {\r\n        if (this.isStart) return;\r\n        this.cloudParticleOuter.cloudFadeEffct(true);\r\n        this.cloudParticleCentrality.cloudFadeEffct(true);\r\n        //this.cloudFadeEffct(true);\r\n    }\r\n\r\n    initPaling() {\r\n        // this.palingRight.active = true;\r\n        // this.palingDown.active = false;\r\n        // this.palingUp.active = false;\r\n        // this.palingLeft.active = false;\r\n\r\n    }\r\n\r\n    async palingEffctTo() {\r\n        this._palingAnimations.right.startMoveDown();\r\n        await Promise.all([\r\n            this._palingAnimations.up.startAnimation(),\r\n            this._palingAnimations.down.startAnimation()\r\n        ]);\r\n    }\r\n\r\n    async palingEffctCallBack() {\r\n        // this.palingRight.active = true;\r\n        // this.palingDown.active = true;\r\n        // this.palingUp.active = true;\r\n        // this.palingLeft.active = true;\r\n\r\n        this.palingAnimation.play();\r\n        this.scheduleOnce(() => {\r\n            this.allEffect();\r\n        }, 0.48)\r\n        this.palingAnimation.once(Animation.EventType.FINISHED, () => {\r\n\r\n\r\n        }, this)\r\n        DataManager.Instance.soundManager.playPalingSound();\r\n        // await this.palingEffctTo();\r\n\r\n        // this._palingAnimations.left.startBounce();\r\n    }\r\n\r\n    fruitGreenCallBack() {\r\n        DataManager.Instance.soundManager.playGrowSound();\r\n        this._fruitScripts.forEach(script => {\r\n            script.setFruitState(\"red\");//\r\n        });\r\n        this._fruitStateChange = true;\r\n        this._updateTimer = 0;\r\n    }\r\n\r\n    fruitRedCallBack() {\r\n        // 筛选绿色果实（优化版）\r\n        //const greenScripts: FruitScript[] = [];\r\n        // for (let i = 0; i < this._fruitScripts.length; i++) {\r\n        //     if (!this._fruitScripts[i].getFruitState()) {\r\n        //         greenScripts.push(this._fruitScripts[i]);\r\n        //     }\r\n        // }\r\n\r\n        // if (greenScripts.length <= 0) return;\r\n\r\n        const randomIndex = Math.floor(Math.random() * this._fruitScripts.length);\r\n        // const fruitScript = greenScripts[randomIndex];\r\n        // fruitScript.setFruitState(\"red\");\r\n\r\n        DataManager.Instance.addCoin(this.coinNum);\r\n\r\n        // 获取对应的coinNode（需要确保结构一致性）\r\n        const coinNode = this._fruitScripts[randomIndex].node.parent.getChildByName(\"coinNode\");\r\n        if (coinNode) {\r\n            this.scheduleOnce(() => {\r\n                this._playCoinEffect(coinNode, this.coinNum);\r\n            }, 0.2);\r\n        } else {\r\n            warn(\"fruit 没有金币的节点\", randomIndex);\r\n        }\r\n\r\n        // this.scheduleOnce(() => {\r\n        //     fruitScript.setFruitState(\"green\");\r\n        // }, 3);\r\n\r\n        this._updateTimer = 0;\r\n    }\r\n\r\n    // 使用固定间隔计时器替代每帧检查\r\n    update(deltaTime: number) {\r\n        if (!this._fruitStateChange) return;\r\n\r\n        this._updateTimer += deltaTime;\r\n        if (this._updateTimer >= this._checkInterval) {\r\n            this.fruitRedCallBack();\r\n            this._updateTimer = 0;\r\n        }\r\n    }\r\n\r\n    lumberyardStart() {\r\n        if (DataManager.Instance.isGameOver) {\r\n            this.scheduleOnce(() => {\r\n                //this._palingAnimations.up.startMoveDown();\r\n                this.palingUp.getComponent(PalingAnimation).startMoveDown();\r\n            }, 0);\r\n        }\r\n    }\r\n\r\n    // 统一管理coinEffect播放\r\n    private _playCoinEffect(node: Node, coinNum: number) {\r\n        if (!node) return;\r\n\r\n        let effect = node.getComponent(coinEffect);\r\n        if (!effect) {\r\n            effect = node.addComponent(coinEffect);\r\n        }\r\n\r\n        effect.setCoinNum(coinNum);\r\n        effect.playEffect();\r\n    }\r\n\r\n    onDestroy() {\r\n        // 清理事件监听\r\n        // eventMgr.targetOff(this);\r\n\r\n        // 清理定时器\r\n        this.unscheduleAllCallbacks();\r\n    }\r\n}"]}