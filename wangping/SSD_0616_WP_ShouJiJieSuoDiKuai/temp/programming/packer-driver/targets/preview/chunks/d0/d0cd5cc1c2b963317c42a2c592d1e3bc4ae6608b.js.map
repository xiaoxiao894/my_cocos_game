{"version":3,"sources":["file:///D:/playable/wangping/SSD_0616_WP_ShouJiJieSuoDiKuai/assets/Script/states/CutCornState.ts"],"names":["_decorator","Animation","tween","Vec3","State","CharacterType","BehaviourType","Global","BubbleFead","ccclass","property","CutCornState","constructor","entity","index","scheduleHandle","cornNode","isFirst","tweenInstance","getNode","character","node","getId","groundEffect","groundObject2_1","cornUnlock","groundObject2_2","groundObject2_3","groundObject2_4","onEnter","callback","isStartMoveEnemyLand","clearAllActions","getType","CHARACTER","characterSkeletalAnimation","console","error","cornIndex","setRotationFromEuler","axe","active","sickle","callFun","ArrowgroundObject2_1","getComponent","Show","ArrowgroundObject2_2","ArrowgroundObject2_3","ArrowgroundObject2_4","attackLoop","frontage","isLandNum","setFindTarget","Idel","idle","scheduleOnce","children","forEach","item","allUnlocked","every","value","isFirstEnemyLand","passAnimation2","play","animationState","getState","speed","soundManager","playCutCronSound","once","EventType","FINISHED","getChildByName","by","position","call","collectCorn","start","stop","unschedule","onUpdate","dt","onExit"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Animation, tween, Vec3, Tween } from 'cc';\r\nimport State from './State';\r\nimport Entity, { CharacterType } from '../entitys/Entity';\r\nimport { BehaviourType, Character } from '../entitys/Character';\r\nimport { Global } from '../core/Global';\r\nimport { BubbleFead } from '../BubbleFead';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('CutCornState')\r\nexport class CutCornState extends State {\r\n    private index = 0;\r\n    // 新增：保存定时器句柄\r\n    private scheduleHandle: any = null;\r\n    constructor(entity: Entity) {\r\n        super();\r\n        this.entity = entity;\r\n    }\r\n    cornNode: Node = null;\r\n    private isFirst: boolean = false;\r\n\r\n    private tweenInstance: Tween<Node> = null;\r\n\r\n    getNode(character) {\r\n\r\n        let node = null;\r\n        if (character.getId() == \"0\") {\r\n            node = character.groundEffect.groundObject2_1;\r\n            Global.cornUnlock[0] = 1;\r\n        } else if (character.getId() == \"1\") {\r\n            Global.cornUnlock[1] = 1;\r\n            node = character.groundEffect.groundObject2_2;\r\n        } else if (character.getId() == \"2\") {\r\n            node = character.groundEffect.groundObject2_3;\r\n            Global.cornUnlock[2] = 1;\r\n        }\r\n        else if (character.getId() == \"3\") {\r\n            node = character.groundEffect.groundObject2_4;\r\n            Global.cornUnlock[3] = 1;\r\n        }\r\n        return node;\r\n\r\n    }\r\n    onEnter(callback?: (...agrs: unknown[]) => void) {\r\n        let character = (this.entity as Character)\r\n        // 新增：检查是否需要立即清除动作\r\n        if (Global.isStartMoveEnemyLand) {\r\n            this.clearAllActions(character);\r\n            return;\r\n        }\r\n        \r\n        if (this.entity.getType() == CharacterType.CHARACTER) {\r\n            if (!this.entity.characterSkeletalAnimation) {\r\n                console.error(\"骨骼动画组件未初始化\");\r\n                return;\r\n            }\r\n\r\n        }\r\n        if (character.cornIndex <= 1) {\r\n            character.node.setRotationFromEuler(0, 0, 0);\r\n            character.cornIndex = 1;\r\n        } else {\r\n            character.node.setRotationFromEuler(0, 180, 0);\r\n            character.cornIndex = 4;\r\n        }\r\n        character.axe.active = false;\r\n        character.sickle.active = true;\r\n\r\n        let callFun = () => {\r\n            if (character.getId() == \"0\") {\r\n                character.groundEffect.ArrowgroundObject2_1.active = true;\r\n                if (character.groundEffect.ArrowgroundObject2_1.getComponent(BubbleFead)) {\r\n                    character.groundEffect.ArrowgroundObject2_1.getComponent(BubbleFead).Show();\r\n                }\r\n\r\n            } else if (character.getId() == \"1\") {\r\n                character.groundEffect.ArrowgroundObject2_2.active = true;\r\n                if (character.groundEffect.ArrowgroundObject2_2.getComponent(BubbleFead)) {\r\n                    character.groundEffect.ArrowgroundObject2_2.getComponent(BubbleFead).Show();\r\n                }\r\n            } else if (character.getId() == \"2\") {\r\n                character.groundEffect.ArrowgroundObject2_3.active = true;\r\n                if (character.groundEffect.ArrowgroundObject2_3.getComponent(BubbleFead)) {\r\n                    character.groundEffect.ArrowgroundObject2_3.getComponent(BubbleFead).Show();\r\n                }\r\n            }\r\n            else if (character.getId() == \"3\") {\r\n                character.groundEffect.ArrowgroundObject2_4.active = true;\r\n                if (character.groundEffect.ArrowgroundObject2_4.getComponent(BubbleFead)) {\r\n                    character.groundEffect.ArrowgroundObject2_4.getComponent(BubbleFead).Show();\r\n                }\r\n\r\n            }\r\n        }\r\n        const attackLoop = () => {\r\n            // 新增：检查是否需要清除动作\r\n            if (Global.isStartMoveEnemyLand) {\r\n                this.clearAllActions(character);\r\n                return;\r\n            }\r\n\r\n            if (character.frontage) {\r\n                if (character.cornIndex > 4) {\r\n                    character.cornIndex = 4;\r\n                    Global.isLandNum++;\r\n                    character.setFindTarget(false);\r\n                    character.BehaviourType = BehaviourType.Idel;\r\n                    character.frontage = false;\r\n                    character.idle();\r\n                    \r\n                    // 修改：保存定时器句柄\r\n                    this.scheduleHandle = this.scheduleOnce(() => {\r\n                        this.cornNode.children.forEach((item) => {\r\n                            item.active = true;\r\n                        })\r\n                        callFun()\r\n\r\n                    }, 3)\r\n\r\n\r\n                    return;\r\n                }\r\n            } else {\r\n                if (character.cornIndex <= 0) {\r\n                    character.setFindTarget(false);\r\n                    character.BehaviourType = BehaviourType.Idel;\r\n                    character.cornIndex = 1;\r\n                    character.frontage = true;\r\n                    character.idle();\r\n                    \r\n                    // 修改：保存定时器句柄\r\n                    this.scheduleHandle = this.scheduleOnce(() => {\r\n                        this.cornNode.children.forEach((item) => {\r\n                            item.active = true;\r\n                            callFun()\r\n                        })\r\n                    }, 3)\r\n\r\n                    const allUnlocked = Global.cornUnlock.every(value => value !== 0);\r\n\r\n                    if (allUnlocked) {\r\n                        if (!Global.isFirstEnemyLand) {\r\n                            Global.isFirstEnemyLand = true;\r\n                            character.groundEffect.passAnimation2();\r\n                        }\r\n                    }\r\n                    return;\r\n                }\r\n            }\r\n\r\n            this.cornNode = this.getNode(character);\r\n            character.characterSkeletalAnimation.play(\"gexiaomai\");\r\n            const animationState = character.characterSkeletalAnimation.getState(\"gexiaomai\");\r\n            animationState.speed = 2.2;\r\n\r\n            Global.soundManager.playCutCronSound()\r\n            character.characterSkeletalAnimation.once(Animation.EventType.FINISHED, () => {\r\n                // 新增：检查是否需要清除动作\r\n                if (Global.isStartMoveEnemyLand) {\r\n                    this.clearAllActions(character);\r\n                    return;\r\n                }\r\n                \r\n                character.characterSkeletalAnimation.play(\"kugongnanpao\");\r\n                this.cornNode.getChildByName(\"ground\" + character.cornIndex).active = false;\r\n                this.tweenInstance = tween(character.node)\r\n                    .by(0.3, { position: new Vec3(0, 0, character.frontage ? 1.6 : -1.6) })\r\n                    .call(() => {\r\n                        // 新增：检查是否需要清除动作\r\n                        if (Global.isStartMoveEnemyLand) {\r\n                            this.clearAllActions(character);\r\n                            return;\r\n                        }\r\n                        \r\n                        character.collectCorn(this.entity);\r\n                        if (Global.isStartMoveEnemyLand == true) {\r\n                            this.clearAllActions(character);\r\n                            return;\r\n                        }\r\n                        if (character.frontage) {\r\n                            character.cornIndex++;\r\n                        } else {\r\n                            character.cornIndex--;\r\n                        }\r\n                        if (Global.isLandNum >= 3) {\r\n                            const allUnlocked = Global.cornUnlock.every(value => value !== 0);\r\n\r\n                            if (allUnlocked) {\r\n                                if (!Global.isFirstEnemyLand) {\r\n                                    Global.isFirstEnemyLand = true;\r\n                                    character.groundEffect.passAnimation2();\r\n                                }\r\n                            }\r\n                        }\r\n                        attackLoop();\r\n                    })\r\n                    .start();\r\n            });\r\n\r\n        }\r\n        attackLoop();\r\n\r\n    }\r\n    \r\n    // 新增：清除所有缓存动作的方法\r\n    private clearAllActions(character: Character) {\r\n        // 停止tween动画\r\n        if (this.tweenInstance) {\r\n            this.tweenInstance.stop();\r\n            this.tweenInstance = null;\r\n        }\r\n        // 取消定时器\r\n        if (this.scheduleHandle) {\r\n            this.unschedule(this.scheduleHandle);\r\n            this.scheduleHandle = null;\r\n        }\r\n        // 停止骨骼动画\r\n        if (character.characterSkeletalAnimation) {\r\n            character.characterSkeletalAnimation.stop();\r\n        }\r\n        // 切换到 idle 状态\r\n        // character.setFindTarget(false);\r\n        // character.BehaviourType = BehaviourType.Idel;\r\n        // character.idle();\r\n    }\r\n\r\n    onUpdate(dt: number) {\r\n        // 新增：在更新时检查是否需要清除动作\r\n        if (Global.isStartMoveEnemyLand) {\r\n            let character = (this.entity as Character);\r\n            this.clearAllActions(character);\r\n        }\r\n    }\r\n\r\n    onExit(callback?: (...agrs: unknown[]) => void) {\r\n        // 新增：退出状态时清除所有动作\r\n        this.clearAllActions(this.entity as Character);\r\n        if (callback) callback();\r\n    }\r\n\r\n}\r\n"]}