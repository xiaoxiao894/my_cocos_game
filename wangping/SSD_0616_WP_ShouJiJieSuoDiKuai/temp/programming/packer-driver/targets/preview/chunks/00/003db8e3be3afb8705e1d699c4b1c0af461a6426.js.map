{"version":3,"sources":["file:///D:/Cocos/PlayAble/SSD_UnlockPlot/assets/Script/states/HandOver.ts"],"names":["_decorator","tween","Vec3","State","CharacterType","BehaviourType","MathUtil","Global","eventMgr","EventType","ccclass","property","HandOver","constructor","entity","target","callBcak","playerBoyNum","onEnter","callback","getType","CHARACTER","characterSkeletalAnimation","console","error","play","playerBodyWoodTest","playerBodyWood","handOver","onUpdate","dt","log","onExit","upgradeUIAnimtion","handOverPosNode","getHandOverPosNode","handOverPos","worldPosition","clone","woodParent","node","getChildByName","children","length","setBehaviour","Idel","setFindTarget","woodNum","treeHandOverNum","treeHandOverNumLimit","emit","ENTITY_HAND_OVER_NO","warn","woodNode","woodWorldPos","getWorldPosition","LIFT_HEIGHT","controlPoint","position","x","y","z","to","scale","easing","ratio","bezierCurve","call","soundManager","playHandOverSound","ENTITY_TREE_COMPLATE","removeFromParent","destroy","ENTITY_HAND_OVER_ADD","start"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, tween, Vec3 } from 'cc';\r\nimport State from './State';\r\nimport Entity, { CharacterType } from '../entitys/Entity';\r\nimport { BehaviourType, Character } from '../entitys/Character';\r\nimport { MathUtil } from '../MathUtils';\r\nimport { Global } from '../core/Global';\r\nimport { eventMgr } from '../core/EventManager';\r\nimport { EventType } from '../core/EventType';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('HandOver')\r\nexport class HandOver extends State {\r\n    target: Entity = null;\r\n    private callBcak: Function = null;\r\n    private playerBoyNum:number = 0;\r\n    constructor(entity: Entity) {\r\n        super();\r\n        this.entity = entity;\r\n\r\n    }\r\n    onEnter(callback?: (...agrs: unknown[]) => void) {\r\n        if (this.entity.getType() == CharacterType.CHARACTER) {\r\n            // 检查骨骼动画组件是否存在\r\n            if (!this.entity.characterSkeletalAnimation) {\r\n                console.error(\"骨骼动画组件未初始化\");\r\n                return;\r\n            }\r\n\r\n            this.entity.characterSkeletalAnimation.play(\"kugongnanidel\");\r\n\r\n            \r\n        }\r\n        Global.playerBodyWoodTest = Global.playerBodyWood;\r\n        this.handOver();\r\n    }\r\n    onUpdate(dt: number) {\r\n        console.log(\"HandOver\")\r\n        // this.handOver();\r\n    }\r\n    onExit(callback?: (...agrs: unknown[]) => void) {\r\n\r\n    }\r\n    handOver() {\r\n        if (Global.playerBodyWood > 0 && Global.upgradeUIAnimtion == 2) {\r\n            Global.upgradeUIAnimtion = 3;\r\n        }\r\n        // 获取交付位置节点\r\n        let handOverPosNode = (this.entity as Character).getHandOverPosNode();\r\n        if (!handOverPosNode) {\r\n            console.error(\"找不到交付位置节点\");\r\n            return;\r\n        }\r\n        let handOverPos = handOverPosNode.worldPosition.clone();\r\n\r\n        // 获取背包节点\r\n        let woodParent = (this.entity as Character).node.getChildByName(\"backpack\");\r\n        if (!woodParent) {\r\n            console.error(\"找不到背包节点\");\r\n            return;\r\n        }\r\n\r\n        // 检查背包中是否有木头\r\n        if (woodParent.children.length <= 0) {\r\n            (this.entity as Character).setBehaviour(BehaviourType.Idel);\r\n            (this.entity as Character).setFindTarget(false);\r\n            (this.entity as Character).woodNum = 0;\r\n            if(Global.treeHandOverNum < Global.treeHandOverNumLimit){\r\n                eventMgr.emit(EventType.ENTITY_HAND_OVER_NO)\r\n            }\r\n            console.warn(\"背包中没有可交付的木头\");\r\n            return;\r\n        }\r\n\r\n        // 获取最后一个木头节点\r\n        const woodNode = woodParent.children[woodParent.children.length - 1];\r\n        const woodWorldPos = woodNode.getWorldPosition().clone();\r\n\r\n        // 计算贝塞尔曲线控制点（提升高度可配置）\r\n        const LIFT_HEIGHT = 10; // 可提取为配置项\r\n        const controlPoint = new Vec3(\r\n            (woodNode.position.x + handOverPos.x) / 2,\r\n            (woodNode.position.y + handOverPos.y) / 2 + LIFT_HEIGHT,\r\n            (woodNode.position.z + handOverPos.z) / 2\r\n        );\r\n\r\n        // 执行贝塞尔曲线动画\r\n        tween(woodNode)\r\n            .to(0.1, {\r\n                scale: new Vec3(1, 1, 1)\r\n            }, {\r\n                easing: 'cubicInOut',\r\n                onUpdate: (target: Node, ratio: number) => {\r\n                    // 计算贝塞尔曲线位置\r\n                    const position = MathUtil.bezierCurve(\r\n                        woodWorldPos,\r\n                        controlPoint,\r\n                        handOverPos,\r\n                        ratio\r\n                    );\r\n                    target.worldPosition = position;\r\n                }\r\n            })\r\n            .call(() => {\r\n                Global.treeHandOverNum++;\r\n                Global.soundManager.playHandOverSound();\r\n                if (Global.treeHandOverNum >= Global.treeHandOverNumLimit) {\r\n                    eventMgr.emit(EventType.ENTITY_TREE_COMPLATE)\r\n                    //Global.upgradeUIAnimtion = 0\r\n                    // woodParent.removeAllChildren();\r\n                    if (woodNode) {\r\n                        (this.entity as Character).woodNum--;\r\n                        if ((this.entity as Character).woodNum < 0) {\r\n                            (this.entity as Character).woodNum = 0;\r\n                        }\r\n                        woodNode.removeFromParent();\r\n                        woodNode.destroy();\r\n                        Global.upgradeUIAnimtion = 5;\r\n                    }\r\n                    return;\r\n                }\r\n                // 增加交付计数\r\n                (this.entity as Character).woodNum--;\r\n                Global.playerBodyWood--;\r\n                Global.playerBodyWoodTest--;\r\n                console.log(\"Global.playerBodyWood == \"+Global.playerBodyWood)\r\n                if(Global.playerBodyWoodTest <= 0){\r\n                    Global.playerBodyWoodTest = 0;\r\n                    Global.upgradeUIAnimtion = 5;\r\n                }\r\n                if ((this.entity as Character).woodNum < 0) {\r\n                    (this.entity as Character).woodNum = 0;\r\n                    if(Global.treeHandOverNum < Global.treeHandOverNumLimit){\r\n                        eventMgr.emit(EventType.ENTITY_HAND_OVER_NO)\r\n                    }\r\n\r\n                }\r\n              \r\n                //Global.upgradeUIAnimtion = 1\r\n               \r\n\r\n                eventMgr.emit(EventType.ENTITY_HAND_OVER_ADD)\r\n                // 从场景中移除木头\r\n\r\n                woodNode.removeFromParent();\r\n                woodNode.destroy();\r\n                this.handOver();\r\n                // 注意：这里不再递归调用this.handOver()\r\n                // 而是通过事件或其他方式通知可以继续交付\r\n                console.log(\"木头交付完成，当前已交付数量:\", Global.treeHandOverNum);\r\n            })\r\n            .start();\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\n\r\n"]}