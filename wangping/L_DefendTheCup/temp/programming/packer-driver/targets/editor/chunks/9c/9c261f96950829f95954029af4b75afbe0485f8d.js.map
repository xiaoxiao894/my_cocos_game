{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_DefendTheCup/assets/JavaScript/Tip/BossTipConMananger.ts"],"names":["_decorator","Camera","Component","instantiate","Node","UITransform","Vec3","DataManager","EntityTypeEnum","ccclass","property","_tempWorldPos","_tempUINodePos","BossTipConMananger","margin","arrowMargin","disableLen","arrowTargets","start","Instance","BossTipConManager","update","arrow","updateArrowForTarget","addTarget","target3D","prefab","prefabMap","get","BoosTip","console","warn","bossTipNode","setParent","node","setSiblingIndex","tipTransform","getComponent","anchorPoint","set","push","removeTarget","index","findIndex","a","destroy","splice","isValid","getWorldPosition","y","camera","convertToUINode","canvas","canvasTransform","halfW","contentSize","width","halfH","height","isInView","x","getChildByName","active","angle","dist","angleRad","Math","PI","sin","cos","setPosition","abs","dir","clone","normalize","atan2","clampedX","min","max","clampedY"],"mappings":"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","sourcesContent":["import { _decorator, Camera, Component, instantiate, Node, UITransform, Vec3, v3 } from 'cc';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { EntityTypeEnum } from '../Enum/Index';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst _tempWorldPos = new Vec3();\r\nconst _tempUINodePos = new Vec3();\r\n\r\n@ccclass('BossTipConMananger')\r\nexport class BossTipConMananger extends Component {\r\n    @property(Camera)\r\n    camera: Camera = null;\r\n\r\n    @property(Node)\r\n    canvas: Node = null;\r\n\r\n    //@property\r\n    private margin: number = 30;\r\n\r\n    private arrowMargin: number = 100;\r\n\r\n    private disableLen: number = 120;\r\n\r\n    private arrowTargets: { target3D: Node, bossTipNode: Node }[] = [];\r\n\r\n    start() {\r\n        DataManager.Instance.BossTipConManager = this;\r\n    }\r\n\r\n    update() {\r\n        for (const arrow of this.arrowTargets) {\r\n            this.updateArrowForTarget(arrow);\r\n        }\r\n    }\r\n\r\n    addTarget(target3D: Node) {\r\n        const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.BoosTip);\r\n        if (!prefab) {\r\n            console.warn(\"BoosTip prefab not found\");\r\n            return;\r\n        }\r\n\r\n        const bossTipNode = instantiate(prefab);\r\n        bossTipNode.setParent(this.node);\r\n        bossTipNode.setSiblingIndex(999);\r\n\r\n        const tipTransform = bossTipNode.getComponent(UITransform);\r\n        if (tipTransform) {\r\n            tipTransform.anchorPoint.set(0.5, 0.5);\r\n        }\r\n\r\n        this.arrowTargets.push({ target3D, bossTipNode });\r\n    }\r\n\r\n    removeTarget(target3D: Node) {\r\n        const index = this.arrowTargets.findIndex(a => a.target3D === target3D);\r\n        if (index >= 0) {\r\n            this.arrowTargets[index].bossTipNode.destroy();\r\n            this.arrowTargets.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    private updateArrowForTarget({ target3D, bossTipNode }) {\r\n        if (!target3D || !target3D.isValid) return;\r\n\r\n        target3D.getWorldPosition(_tempWorldPos);\r\n\r\n        //  提高箭头在目标上方\r\n        _tempWorldPos.y += 3.5;\r\n\r\n        //  3D → UI 坐标\r\n        this.camera.convertToUINode(_tempWorldPos, this.canvas, _tempUINodePos);\r\n\r\n        const canvasTransform = this.canvas.getComponent(UITransform)!;\r\n        const halfW = canvasTransform.contentSize.width / 2;\r\n        const halfH = canvasTransform.contentSize.height / 2;\r\n\r\n        //  判断是否在视野内\r\n        const isInView =\r\n            _tempUINodePos.x >= -halfW + this.margin &&\r\n            _tempUINodePos.x <= halfW - this.margin &&\r\n            _tempUINodePos.y >= -halfH + this.margin &&\r\n            _tempUINodePos.y <= halfH - this.margin;\r\n\r\n        const arrow = bossTipNode.getChildByName(\"Arrow\");\r\n        bossTipNode.active = true;\r\n\r\n        if (isInView) {\r\n            // 屏幕内：箭头归零，位置靠近目标\r\n            if (arrow) arrow.angle = 0;\r\n            bossTipNode.active = false;\r\n\r\n            const dist = 100;\r\n            const angleRad = bossTipNode.angle * Math.PI / 180;\r\n            _tempUINodePos.x += -Math.sin(angleRad) * dist;\r\n            _tempUINodePos.y += Math.cos(angleRad) * dist;\r\n            bossTipNode.setPosition(_tempUINodePos);\r\n\r\n            if (Math.abs(_tempUINodePos.x) < this.disableLen || Math.abs(_tempUINodePos.y) < this.disableLen) {\r\n                bossTipNode.active = false;\r\n            }\r\n\r\n        } else {\r\n            // 屏幕外：箭头指向目标方向\r\n            const dir = _tempUINodePos.clone().normalize();\r\n            if (arrow) arrow.angle = Math.atan2(dir.y, dir.x) * 180 / Math.PI + 90;\r\n\r\n            const clampedX = Math.min(Math.max(_tempUINodePos.x, -halfW + this.arrowMargin), halfW - this.arrowMargin);\r\n            const clampedY = Math.min(Math.max(_tempUINodePos.y, -halfH + this.arrowMargin), halfH - this.arrowMargin);\r\n\r\n            bossTipNode.setPosition(new Vec3(clampedX, clampedY, 0));\r\n\r\n            bossTipNode.active = true;\r\n        }\r\n    }\r\n\r\n}\r\n"]}