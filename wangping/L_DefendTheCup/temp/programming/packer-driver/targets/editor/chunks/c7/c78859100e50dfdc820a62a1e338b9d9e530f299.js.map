{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_DefendTheCup/assets/JavaScript/Actor/MinionConManager.ts"],"names":["_decorator","Component","instantiate","Node","Vec3","tween","find","director","Animation","DataManager","EntityTypeEnum","MinionManager","MinionStateEnum","Actor","ccclass","property","MinionConManager","birthPoint","queuePosition","exitRoute","moveSpeed","spawnCooldown","_spawnTimer","_targetMonsters","isSettlementInterface","_isDeliveringMinion","_deliverInterval","_activeMovingMinions","Set","start","Instance","update","deltaTime","isStartGame","checkQueueAndRefill","goOutMinion","node","children","i","length","minion","targetPos","minionManager","getComponent","currentPos","position","distance","changState","Idle","_tweenTarget","equals","clone","Walk","duration","stop","to","call","prefab","prefabMap","get","Minion","setParent","setPosition","validWeapons","minionWeaponCon","filter","w","weapon","isValid","isAllMinionsPassed","weaponStart","getWorldPosition","minionWorld","weaponTarget","add","controlPoint","x","Math","max","y","z","parent","setWorldPosition","isGameEnd","controller","t","easing","onUpdate","oneMinusT","pos","destroy","scheduleOnce","gameEndManager","init","worldPos","worldPosition","effectPrefab","TX_shengjiLZ","skillExplosion","getScene","addChild","anim","play","once","EventType","FINISHED","lookingMonsterMinionCon","geometry","getChildByName","active","route","moveChain","target","random","dir","subtract","normalize","targetAngle","atan2","PI","eulerAngles","bSide","bDoor","doorL","doorR","player","openDoorBySide","delete","size","closeDoorBySide","soldiersChasingMonsters","isLookingForMonsters","addMonsterTarget","push","removeMonsterTarget","index","indexOf","splice","hasTarget"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Node, Vec3, tween, find, director, Animation, Camera } from 'cc';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { EntityTypeEnum } from '../Enum/Index';\r\nimport { MinionManager } from './MinionManager';\r\nimport { MinionStateEnum } from './StateDefine';\r\nimport { Actor } from './Actor';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('MinionConManager')\r\nexport class MinionConManager extends Component {\r\n    @property(Node)\r\n    minionWeaponCon: Node = null;\r\n\r\n    @property(Node)\r\n    lookingMonsterMinionCon: Node = null;\r\n\r\n    // 怪容器\r\n    @property(Node)\r\n    monsterParent: Node = null;\r\n\r\n    // 起点\r\n    birthPoint = new Vec3(-0.657, 0, 9);\r\n\r\n    // 排队\r\n    queuePosition = [\r\n        new Vec3(-0.657, 0, 21),\r\n        new Vec3(-0.657, 0, 18),\r\n        new Vec3(-0.657, 0, 15),\r\n        new Vec3(-0.657, 0, 12),\r\n    ];\r\n    // 出门路径\r\n    exitRoute = [new Vec3(-0.657, 0, 25), new Vec3(8.411, 0, 25), new Vec3(8.411, 0, 33)];\r\n\r\n    moveSpeed = 5;\r\n    spawnCooldown = 1.5;\r\n    private _spawnTimer = 0;\r\n\r\n    private _targetMonsters: Node[] = [];\r\n\r\n    // 是否出现结算结束截面\r\n    private isSettlementInterface = false;\r\n\r\n    protected start(): void {\r\n        DataManager.Instance.MinionConManager = this;\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n        if (DataManager.Instance.isStartGame) {\r\n            this._spawnTimer += deltaTime;\r\n            this.checkQueueAndRefill();\r\n\r\n            // 小兵出门\r\n            this.goOutMinion();\r\n        }\r\n    }\r\n\r\n    // 填充队列\r\n    checkQueueAndRefill() {\r\n        if (!this.node) return;\r\n\r\n        const children = this.node.children;\r\n\r\n        // 已有小兵自动前进补位\r\n        for (let i = 0; i < children.length; i++) {\r\n            const minion = children[i];\r\n            const targetPos = this.queuePosition[i];\r\n\r\n            if (!minion) continue;\r\n\r\n            const minionManager = minion?.children[0].getComponent(MinionManager);\r\n            const currentPos = minion.position;\r\n\r\n            // 如果已经在位置上，确保状态为 Idle\r\n            if (Vec3.distance(currentPos, targetPos) < 0.01) {\r\n                minionManager.changState(MinionStateEnum.Idle);\r\n                continue;\r\n            }\r\n\r\n            if ((minion as any)._tweenTarget?.equals(targetPos)) continue;\r\n\r\n            (minion as any)._tweenTarget = targetPos.clone();\r\n\r\n            // 开始移动时切换为 Walk\r\n            minionManager.changState(MinionStateEnum.Walk);\r\n\r\n            const duration = Vec3.distance(currentPos, targetPos) / this.moveSpeed;\r\n\r\n            tween(minion)\r\n                .stop()\r\n                .to(duration, { position: targetPos })\r\n                .call(() => {\r\n                    delete (minion as any)._tweenTarget;\r\n\r\n                    // 移动结束后切换为 Idle\r\n                    minionManager.changState(MinionStateEnum.Idle);\r\n                })\r\n                .start();\r\n        }\r\n\r\n        // 如果人数不足，创建新兵补到队尾\r\n        if (children.length < this.queuePosition.length && this._spawnTimer >= this.spawnCooldown) {\r\n            const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.Minion);\r\n            if (!prefab) return;\r\n\r\n            const minion = instantiate(prefab);\r\n            minion.setParent(this.node);\r\n            minion.setPosition(this.birthPoint.clone());\r\n\r\n            const minionManager = minion.children[0].getComponent(MinionManager);\r\n            minionManager.changState(MinionStateEnum.Walk);\r\n\r\n            const targetPos = this.queuePosition[children.length - 1];\r\n            const duration = Vec3.distance(this.birthPoint, targetPos) / this.moveSpeed;\r\n\r\n            (minion as any)._tweenTarget = targetPos.clone();\r\n\r\n            tween(minion)\r\n                .to(duration, { position: targetPos })\r\n                .call(() => {\r\n                    delete (minion as any)._tweenTarget;\r\n\r\n                    // 移动完成后切换为 Idle\r\n                    minionManager.changState(MinionStateEnum.Idle);\r\n                })\r\n                .start();\r\n\r\n            this._spawnTimer = 0;\r\n        }\r\n    }\r\n\r\n    private _isDeliveringMinion = false;\r\n    private _deliverInterval = 1;\r\n\r\n    // === 添加到类成员中 ===\r\n    private _activeMovingMinions: Set<Node> = new Set(); // 追踪正在出门的小兵\r\n\r\n    // === 完整 goOutMinion 方法 ===\r\n    goOutMinion() {\r\n        if (this._isDeliveringMinion) return;\r\n        if (this.node.children.length <= 0) return;\r\n\r\n        const validWeapons = this.minionWeaponCon.children.filter(w => w[\"__delivered\"] && !w[\"__used\"]);\r\n        if (validWeapons.length <= 0) return;\r\n\r\n        this._isDeliveringMinion = true;\r\n\r\n        const weapon = validWeapons[validWeapons.length - 1];\r\n        if (!weapon?.isValid) {\r\n            this._isDeliveringMinion = false;\r\n            return;\r\n        }\r\n\r\n        const minion = this.node.children[0];\r\n        if (!minion?.isValid) {\r\n            this._isDeliveringMinion = false;\r\n            return;\r\n        }\r\n\r\n        DataManager.Instance.isAllMinionsPassed = false;\r\n\r\n        // 延迟标记为“已使用”，防止出列过早\r\n        weapon[\"__used\"] = true;\r\n\r\n        const weaponStart = weapon.getWorldPosition();\r\n        const minionWorld = minion.getWorldPosition();\r\n        const weaponTarget = minionWorld.clone().add(new Vec3(0, 2, 0));\r\n        const controlPoint = new Vec3(\r\n            (weaponStart.x + weaponTarget.x) / 2,\r\n            Math.max(weaponStart.y, weaponTarget.y) + 5,\r\n            (weaponStart.z + weaponTarget.z) / 2\r\n        );\r\n\r\n        // 先放到世界空间中进行动画\r\n        weapon.setParent(this.node.parent);\r\n        weapon.setWorldPosition(weaponStart);\r\n        if (DataManager.Instance.isGameEnd) return;\r\n\r\n        const controller = { t: 0 };\r\n        tween(controller)\r\n            .to(0.4, { t: 1 }, {\r\n                easing: 'quadOut',\r\n                onUpdate: () => {\r\n                    if (!weapon?.isValid) return;\r\n                    const t = controller.t;\r\n                    const oneMinusT = 1 - t;\r\n                    const pos = new Vec3(\r\n                        oneMinusT * oneMinusT * weaponStart.x + 2 * oneMinusT * t * controlPoint.x + t * t * weaponTarget.x,\r\n                        oneMinusT * oneMinusT * weaponStart.y + 2 * oneMinusT * t * controlPoint.y + t * t * weaponTarget.y,\r\n                        oneMinusT * oneMinusT * weaponStart.z + 2 * oneMinusT * t * controlPoint.z + t * t * weaponTarget.z\r\n                    );\r\n                    weapon.setWorldPosition(pos);\r\n                }\r\n            })\r\n            .call(() => {\r\n                if (weapon) weapon.destroy();\r\n                //const worldFinal = weapon.getWorldPosition();\r\n                // weapon.setParent(minion);\r\n                // weapon.setWorldPosition(worldFinal);、\r\n                // 小兵拿到的武器是否是通过传送带传送过来的\r\n                if (weapon && weapon[`__isTransferredWeapons`] && !this.isSettlementInterface) {\r\n                    this.isSettlementInterface = true;\r\n                    this.scheduleOnce(() => {\r\n                        DataManager.Instance.isGameEnd = true;\r\n                        DataManager.Instance.gameEndManager.init();\r\n                    }, 1)\r\n                }\r\n\r\n                const worldPos = weapon.worldPosition;\r\n                const effectPrefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.TX_shengjiLZ)\r\n                const skillExplosion = instantiate(effectPrefab);\r\n                director.getScene().addChild(skillExplosion);\r\n                skillExplosion.setWorldPosition(new Vec3(worldPos.x, worldPos.y, worldPos.z));\r\n\r\n                const anim = skillExplosion?.getComponent(Animation);\r\n                if (anim) {\r\n                    anim.play(`TX_shengjiLZ`);\r\n                    anim.once(Animation.EventType.FINISHED, () => {\r\n                        skillExplosion.destroy();\r\n                    });\r\n                } else {\r\n                    // 没动画时，延迟回收\r\n                    this.scheduleOnce(() => {\r\n                        skillExplosion.destroy();\r\n                    }, 1);\r\n                }\r\n\r\n                // 出列：小兵移动准备\r\n                minion.setParent(this.lookingMonsterMinionCon);\r\n                const minionManager = minion.children[0].getComponent(MinionManager);\r\n                if (minionManager) minionManager.changState(MinionStateEnum.Walk);\r\n\r\n                const geometry = minion?.children[0]?.getChildByName(\"Geometry\");\r\n                if (geometry) {\r\n                    geometry.active = true;\r\n                }\r\n\r\n                const route = this.exitRoute;\r\n                let moveChain = tween(minion);\r\n\r\n                this._activeMovingMinions.add(minion); // ➕ 追踪当前出门小兵\r\n\r\n\r\n                for (let i = 0; i < route.length; i++) {\r\n                    const target = route[i].clone();\r\n                    if (i === 2) {\r\n                        target.z += Math.random() * 20;\r\n                    }\r\n\r\n                    moveChain = moveChain\r\n                        .call(() => {\r\n                            const currentPos = minion.getWorldPosition();\r\n                            const dir = new Vec3();\r\n                            Vec3.subtract(dir, target, currentPos);\r\n                            dir.y = 0;\r\n                            dir.normalize();\r\n\r\n                            const targetAngle = Math.atan2(dir.x, dir.z) * 180 / Math.PI;\r\n\r\n                            tween(minion)\r\n                                .to(0.3, { eulerAngles: new Vec3(0, targetAngle, 0) }, { easing: 'sineInOut' })\r\n                                .start();\r\n\r\n                            if (i === 2) {\r\n                                const bSide = find(\"ThreeDNode/Map/Fences/Scene1/BSide\");\r\n                                const bDoor = bSide?.getChildByName(\"B_Door\");\r\n                                if (bDoor) {\r\n                                    const doorL = bDoor.getChildByName(\"Door_Left\");\r\n                                    const doorR = bDoor.getChildByName(\"Door_Right\");\r\n                                    DataManager.Instance.player.getComponent(Actor).openDoorBySide(doorL, doorR, \"B\");\r\n                                }\r\n                            }\r\n                        })\r\n                        .to(Vec3.distance(minion.getWorldPosition(), target) / this.moveSpeed, {\r\n                            worldPosition: target\r\n                        }, { easing: 'linear' });\r\n                }\r\n\r\n                moveChain\r\n                    .call(() => {\r\n                        // ✅ 出门完成，从追踪集合中移除\r\n                        this._activeMovingMinions.delete(minion);\r\n\r\n                        // ✅ 所有出门小兵完成，才关门\r\n                        if (this._activeMovingMinions.size === 0) {\r\n                            DataManager.Instance.isAllMinionsPassed = true;\r\n\r\n                            const bSide = find(\"ThreeDNode/Map/Fences/Scene1/BSide\");\r\n                            const bDoor = bSide?.getChildByName(\"B_Door\");\r\n                            if (bDoor) {\r\n                                const doorL = bDoor.getChildByName(\"Door_Left\");\r\n                                const doorR = bDoor.getChildByName(\"Door_Right\");\r\n                                DataManager.Instance.player.getComponent(Actor).closeDoorBySide(doorL, doorR, \"B\", true);\r\n                            }\r\n                        }\r\n\r\n                        this.soldiersChasingMonsters?.(minion);\r\n                    })\r\n                    .start();\r\n\r\n                this.scheduleOnce(() => {\r\n                    this._isDeliveringMinion = false;\r\n                    this.goOutMinion(); // 自动继续下一个\r\n                }, this._deliverInterval);\r\n            })\r\n            .start();\r\n    }\r\n\r\n    // 兵，追怪\r\n    soldiersChasingMonsters(minion) {\r\n        // console.log(`${minion.name} 开始追击`);\r\n        const minionManager = minion.children[0].getComponent(MinionManager);\r\n        minionManager.isLookingForMonsters = true;\r\n        minionManager.init();\r\n    }\r\n\r\n    public addMonsterTarget(node: Node) {\r\n        this._targetMonsters.push(node);\r\n        //console.log(`增加目标 ${node.uuid}`);\r\n    }\r\n\r\n    public removeMonsterTarget(node: Node) {\r\n        let index: number = this._targetMonsters.indexOf(node);\r\n        if (index >= 0) {\r\n            this._targetMonsters.splice(index, 1);\r\n            //console.log(`移除目标 ${node.uuid}`);\r\n        } else {\r\n            if (node) {\r\n                // console.log(`目标 ${node.uuid} 不存在`);\r\n            } else {\r\n                // console.log(`目标为空`);\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    public hasTarget(node: Node) {\r\n        return this._targetMonsters.indexOf(node) !== -1;\r\n    }\r\n}"]}