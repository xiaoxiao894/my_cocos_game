{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_DefendTheCup/assets/JavaScript/Actor/WeaponManager.ts"],"names":["_decorator","CCFloat","Component","instantiate","Mat4","Node","SkeletalAnimation","tween","Vec3","DataManager","EntityTypeEnum","ccclass","property","WeaponManager","_maxWeaponCount","_timer","_slotSyncTimer","weaponPos","weapons","_slotOccupied","_tieJiang","_tieJiangAni","_isTransmitting","_transmitTimer","_transmitInterval","start","node","getChildByName","getComponent","console","error","update","deltaTime","Instance","isConveyorBeltUnlocking","automaticallyTransmitAni","isGenerateWeapons","children","length","stop","createInterval","createWeapon","syncSlotOccupiedState","i","pos","occupied","child","localPos","inverseTransformPoint","getWorldPosition","distance","prefab","prefabMap","get","Weapon","slotIndex","expectedPos","isOccupied","worldPos","end","clone","duration","crossFade","scheduleOnce","spawnAndAnimateWeapon","weapon","setParent","setPosition","to","position","easing","call","finalLocal","__slotIndex","playerWeaponRotationAni","startEuler","eulerAngles","targetEuler","rotCtrl","t","onUpdate","currentEuler","lerp","setRotationFromEuler","x","y","z","getLastPositionWeapon","lastWeapon","isValid","undefined","worldStartPos","worldRotation","getWorldRotation","temporaryWeapons","setWorldPosition","setWorldRotation","jumpTarget","transferStart","jumpMid","Math","max","controller","oneMinusT","basePos","add3f","center","transferCenter","transferEnd","worldPosition","total","minionWeaponCon","itemsPerRow","spacingZ","spacingY","col","row","floor","localTarget","worldTarget","worldRot","worldScale","getWorldScale","mat","fromRTS","targetPos","transformMat4","finalStart","finalControl","min","finalController","__delivered","filter","w","sort","a","b"],"mappings":"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","sourcesContent":["import { _decorator, CCFloat, Component, instantiate, Mat4, Node, Prefab, SkeletalAnimation, tween, Vec3 } from 'cc';\r\nimport { DataManager } from '../Global/DataManager';\r\nimport { EntityTypeEnum } from '../Enum/Index';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\nexport class WeaponManager extends Component {\r\n    @property(CCFloat)\r\n    createInterval = 2;\r\n\r\n    @property(Node)\r\n    temporaryWeapons: Node = null;\r\n\r\n    @property(Node)\r\n    transferStart: Node = null;\r\n\r\n    @property(Node)\r\n    transferCenter: Node = null;\r\n\r\n    @property(Node)\r\n    transferEnd: Node = null;\r\n\r\n    @property(Node)\r\n    minionWeaponCon: Node = null;\r\n\r\n    private _maxWeaponCount = 3;\r\n    private _timer = 0;\r\n    private _slotSyncTimer = 0;\r\n\r\n    weaponPos = [\r\n        new Vec3(0.839, -2.448, -1.216),\r\n        new Vec3(2.003, -2.448, -1.216),\r\n        new Vec3(3.277, -2.448, -1.216)\r\n    ];\r\n\r\n    weapons: Node = null;\r\n    private _slotOccupied: boolean[] = [false, false, false];\r\n    private _tieJiang: Node = null;\r\n    private _tieJiangAni: SkeletalAnimation = null;\r\n\r\n    private _isTransmitting: boolean = false;\r\n    private _transmitTimer: number = 0;\r\n    private _transmitInterval: number = 0.1;\r\n\r\n    start() {\r\n        this._tieJiang = this.node.getChildByName(\"TieJiang\");\r\n        this._tieJiangAni = this._tieJiang.getComponent(SkeletalAnimation);\r\n\r\n        this.weapons = this.node.getChildByName(\"Weapons\");\r\n        if (!this.weapons) {\r\n            console.error(\"Weapons 节点未找到\");\r\n        }\r\n    }\r\n\r\n    update(deltaTime: number) {\r\n        if (DataManager.Instance.isConveyorBeltUnlocking) {\r\n            this._transmitTimer += deltaTime;\r\n            if (!this._isTransmitting && this._transmitTimer >= this._transmitInterval) {\r\n                this._transmitTimer = 0;\r\n                this.automaticallyTransmitAni();\r\n            }\r\n        }\r\n\r\n        // 是否生成武器\r\n        if (!DataManager.Instance.isGenerateWeapons) return;\r\n        if (!this.weapons) return;\r\n\r\n        if (this.weapons?.children.length >= this._maxWeaponCount) {\r\n            this._tieJiangAni.stop();\r\n            return;\r\n        }\r\n\r\n        this._timer += deltaTime;\r\n        if (this._timer >= this.createInterval) {\r\n            this._timer = 0;\r\n            this.createWeapon();\r\n        }\r\n\r\n        this._slotSyncTimer += deltaTime;\r\n        if (this._slotSyncTimer >= 1) {\r\n            this.syncSlotOccupiedState();\r\n            this._slotSyncTimer = 0;\r\n        }\r\n    }\r\n\r\n    private syncSlotOccupiedState() {\r\n        for (let i = 0; i < this.weaponPos.length; i++) {\r\n            const pos = this.weaponPos[i];\r\n            let occupied = false;\r\n\r\n            for (const child of this.weapons.children) {\r\n                const localPos = this.weapons.inverseTransformPoint(new Vec3(), child.getWorldPosition());\r\n                if (Vec3.distance(localPos, pos) < 0.1) {\r\n                    occupied = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            this._slotOccupied[i] = occupied;\r\n        }\r\n    }\r\n\r\n    createWeapon() {\r\n        if (!this._tieJiang || !this.weapons) return;\r\n\r\n        const prefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.Weapon);\r\n        if (!prefab) return;\r\n\r\n        let slotIndex = -1;\r\n\r\n        for (let i = 0; i < this.weaponPos.length; i++) {\r\n            const expectedPos = this.weaponPos[i];\r\n            let isOccupied = false;\r\n\r\n            for (const child of this.weapons.children) {\r\n                const worldPos = child.getWorldPosition();\r\n                const localPos = this.weapons.inverseTransformPoint(new Vec3(), worldPos);\r\n                if (Vec3.distance(localPos, expectedPos) < 0.1) {\r\n                    isOccupied = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!isOccupied) {\r\n                slotIndex = i;\r\n                this._slotOccupied[i] = true;\r\n                break;\r\n            } else {\r\n                this._slotOccupied[i] = true;\r\n            }\r\n        }\r\n\r\n        if (slotIndex === -1) return;\r\n\r\n        const end = this.weaponPos[slotIndex].clone();\r\n        const duration = 0.6;\r\n        this._tieJiangAni.crossFade(\"Take 001\", 0.1);\r\n\r\n        this.scheduleOnce(() => {\r\n            this.spawnAndAnimateWeapon(prefab, end, duration, slotIndex);\r\n        }, 0.67);\r\n    }\r\n\r\n    private spawnAndAnimateWeapon(prefab: Prefab, end: Vec3, duration: number, slotIndex: number) {\r\n        const weapon = instantiate(prefab);\r\n        weapon.setParent(this.node);\r\n        weapon.setPosition(new Vec3(1.719, -8.208, -1.43));\r\n\r\n        tween(weapon)\r\n            .to(duration, { position: end }, { easing: 'quadInOut' })\r\n            .call(() => {\r\n                const worldPos = weapon.getWorldPosition();\r\n                const finalLocal = this.weapons.inverseTransformPoint(new Vec3(), worldPos);\r\n                weapon.setParent(this.weapons);\r\n                weapon.setPosition(finalLocal);\r\n                (weapon as any).__slotIndex = slotIndex;\r\n            })\r\n            .start();\r\n    }\r\n\r\n    playerWeaponRotationAni(weapon) {\r\n        const duration = 0.6;\r\n        const startEuler = weapon.children[0].eulerAngles.clone();\r\n        const targetEuler = new Vec3(123, -8, 180);\r\n        const rotCtrl = { t: 0 };\r\n\r\n        tween(rotCtrl)\r\n            .to(duration, { t: 1 }, {\r\n                easing: 'quadOut',\r\n                onUpdate: () => {\r\n                    const t = rotCtrl.t;\r\n                    const currentEuler = new Vec3();\r\n                    Vec3.lerp(currentEuler, startEuler, targetEuler, t);\r\n                    weapon.children[0].setRotationFromEuler(currentEuler.x, currentEuler.y, currentEuler.z);\r\n                }\r\n            })\r\n            .start();\r\n    }\r\n\r\n    automaticallyTransmitAni() {\r\n        if (this._isTransmitting || !this.weapons) return;\r\n\r\n        // 排列顺序\r\n        this.getLastPositionWeapon();\r\n        const children = this.weapons.children;\r\n        if (children.length === 0) return;\r\n\r\n        const lastWeapon = children[children.length - 1];\r\n        if (!lastWeapon || !lastWeapon.isValid) return;\r\n\r\n        this._isTransmitting = true;\r\n\r\n        const slotIndex = (lastWeapon as any).__slotIndex;\r\n        if (slotIndex !== undefined) {\r\n            this._slotOccupied[slotIndex] = false;\r\n        }\r\n\r\n        const worldStartPos = lastWeapon.getWorldPosition();\r\n        const worldRotation = lastWeapon.children[0].getWorldRotation();\r\n\r\n        lastWeapon.setParent(this.temporaryWeapons);\r\n        lastWeapon.setWorldPosition(worldStartPos);\r\n        lastWeapon.children[0].setWorldRotation(worldRotation);\r\n\r\n        const jumpTarget = this.transferStart.getWorldPosition();\r\n        const jumpMid = new Vec3(\r\n            (worldStartPos.x + jumpTarget.x) / 2,\r\n            Math.max(worldStartPos.y, jumpTarget.y) + 2,\r\n            (worldStartPos.z + jumpTarget.z) / 2\r\n        );\r\n\r\n        const controller = { t: 0 };\r\n        tween(controller)\r\n            .to(0.4, { t: 1 }, {\r\n                easing: 'quadOut',\r\n                onUpdate: () => {\r\n                    const t = controller.t;\r\n                    const oneMinusT = 1 - t;\r\n                    const pos = new Vec3(\r\n                        oneMinusT * oneMinusT * worldStartPos.x + 2 * oneMinusT * t * jumpMid.x + t * t * jumpTarget.x,\r\n                        oneMinusT * oneMinusT * worldStartPos.y + 2 * oneMinusT * t * jumpMid.y + t * t * jumpTarget.y,\r\n                        oneMinusT * oneMinusT * worldStartPos.z + 2 * oneMinusT * t * jumpMid.z + t * t * jumpTarget.z\r\n                    );\r\n                    lastWeapon.setWorldPosition(pos);\r\n                }\r\n            })\r\n            .call(() => {\r\n                const basePos = lastWeapon.getWorldPosition();\r\n                tween(lastWeapon)\r\n                    .to(0.15, { position: basePos.clone().add3f(0, 0.5, 0) }, { easing: 'quadOut' })\r\n                    .to(0.15, { position: basePos }, { easing: 'bounceOut' })\r\n                    .call(() => {\r\n                        const center = this.transferCenter.getWorldPosition();\r\n                        const end = this.transferEnd.getWorldPosition();\r\n\r\n                        tween(lastWeapon)\r\n                            .to(0.6, { worldPosition: center }, { easing: 'linear' })\r\n                            .to(1.2, { worldPosition: end }, { easing: 'linear' })\r\n                            .call(() => {\r\n                                this.playerWeaponRotationAni(lastWeapon);\r\n\r\n                                const total = this.minionWeaponCon.children.length;\r\n                                const itemsPerRow = 4;\r\n                                const spacingZ = 1.3;\r\n                                const spacingY = 1;\r\n                                const col = total % itemsPerRow;\r\n                                const row = Math.floor(total / itemsPerRow);\r\n\r\n                                const localTarget = new Vec3(0, row * spacingY, col * spacingZ);\r\n                                const worldTarget = this.minionWeaponCon.getWorldPosition().clone();\r\n                                const worldRot = this.minionWeaponCon.getWorldRotation();\r\n                                const worldScale = this.minionWeaponCon.getWorldScale();\r\n                                const mat = new Mat4();\r\n                                Mat4.fromRTS(mat, worldRot, worldTarget, worldScale);\r\n\r\n                                const targetPos = Vec3.transformMat4(new Vec3(), localTarget, mat);\r\n                                const finalStart = lastWeapon.getWorldPosition();\r\n                                const finalControl = new Vec3(\r\n                                    (finalStart.x + targetPos.x) / 2,\r\n                                    Math.min(Math.max(finalStart.y, targetPos.y) + 2, 5),\r\n                                    (finalStart.z + targetPos.z) / 2\r\n                                );\r\n\r\n                                const finalController = { t: 0 };\r\n                                tween(finalController)\r\n                                    .to(0.4, { t: 1 }, {\r\n                                        easing: 'quadInOut',\r\n                                        onUpdate: () => {\r\n                                            const t = finalController.t;\r\n                                            const oneMinusT = 1 - t;\r\n                                            const pos = new Vec3(\r\n                                                oneMinusT * oneMinusT * finalStart.x + 2 * oneMinusT * t * finalControl.x + t * t * targetPos.x,\r\n                                                oneMinusT * oneMinusT * finalStart.y + 2 * oneMinusT * t * finalControl.y + t * t * targetPos.y,\r\n                                                oneMinusT * oneMinusT * finalStart.z + 2 * oneMinusT * t * finalControl.z + t * t * targetPos.z\r\n                                            );\r\n                                            lastWeapon.setWorldPosition(pos);\r\n                                        }\r\n                                    })\r\n                                    .call(() => {\r\n                                        // 被传送过来的武器\r\n                                        (lastWeapon as any).__delivered = true;\r\n                                        lastWeapon[`__isTransferredWeapons`] = true;\r\n                                        lastWeapon.setParent(this.minionWeaponCon);\r\n                                        lastWeapon.setWorldPosition(targetPos);\r\n                                        this._isTransmitting = false;\r\n                                    })\r\n                                    .start();\r\n                            })\r\n                            .start();\r\n                    })\r\n                    .start();\r\n            })\r\n            .start();\r\n    }\r\n\r\n    getLastPositionWeapon() {\r\n        const weapons = this.weapons.children.filter(w => w && w.isValid);\r\n        if (weapons.length === 0) return null;\r\n\r\n        weapons.sort((a, b) => b.worldPosition.z - a.worldPosition.z);\r\n    }\r\n}"]}