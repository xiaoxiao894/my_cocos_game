{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_DefendTheCup/assets/JavaScript/UI/UIPartnerEnergyBarManager.ts"],"names":["_decorator","Animation","Color","Component","find","Graphics","Vec3","PartnerManager","ccclass","property","UIPartnerEnergyBarManager","radius","duration","progressBarGraphics","elapsed","_hasInit","_hasPlayedSkillFinish","start","camera","cameraPos","worldPosition","node","lookAt","UP","circleThree","getChildByName","console","warn","getComponent","addComponent","fillColor","fromHEX","createGraphics","strokeColor","graphics","circle","fill","stroke","update","deltaTime","updateUiFollow","partnerParent","parent","partnerManager","anim","skillState","getState","isPlaying","drawFullCircle","playSkillAllAndRelease","progress","startAngle","Math","PI","endAngle","clear","moveTo","arc","lineTo","isSkillAllPlaying","off","EventType","FINISHED","stop","play","once","releaseMajorSkills","direction","aniName","name","slice","clipName","dirState"],"mappings":"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","sourcesContent":["import { _decorator, Animation, Color, Component, find, Graphics, Node, Vec3 } from 'cc';\r\nimport { PartnerManager } from '../Actor/PartnerManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('UIPartnerEnergyBarManager')\r\nexport class UIPartnerEnergyBarManager extends Component {\r\n\r\n    radius: number = 25;\r\n    // 更新时间\r\n    duration: number = 12.0;\r\n\r\n    private progressBarGraphics: Graphics = null!;\r\n    private elapsed = 0;\r\n\r\n    start() {\r\n        const camera = find(\"Main Camera\");\r\n        const cameraPos = camera.worldPosition;\r\n        this.node.lookAt(cameraPos, Vec3.UP)\r\n\r\n        const circleThree = this.node.getChildByName(\"Circle3\");\r\n        if (!circleThree) {\r\n            console.warn(\"Circle3 节点未找到\");\r\n            return;\r\n        }\r\n\r\n        this.progressBarGraphics = circleThree.getComponent(Graphics) || circleThree.addComponent(Graphics);\r\n        this.progressBarGraphics.fillColor = Color.fromHEX(new Color(), \"#00FF00\");\r\n    }\r\n\r\n    createGraphics(node: Node, fillColor: string, strokeColor: string, radius: number) {\r\n        const graphics = node.getComponent(Graphics) || node.addComponent(Graphics);\r\n        graphics.fillColor = Color.fromHEX(new Color(), fillColor);\r\n        graphics.strokeColor = Color.fromHEX(new Color(), strokeColor);\r\n\r\n        graphics.circle(0, 0, radius);\r\n        graphics.fill();\r\n        graphics.stroke();\r\n    }\r\n\r\n    private _hasInit = false;\r\n    private _hasPlayedSkillFinish = false;\r\n\r\n    update(deltaTime: number) {\r\n        this.updateUiFollow();\r\n\r\n        const partnerParent = this.node.parent.getChildByName(\"PartnerParent\");\r\n        const partnerManager = this.node.parent.getComponent(PartnerManager);\r\n        const anim = partnerParent?.getComponent(Animation);\r\n        const skillState = anim?.getState(\"skillALL\");\r\n\r\n        // skillALL 正在播放中，等待完成\r\n        if (skillState?.isPlaying) return;\r\n\r\n        // 初次满圈立即释放技能\r\n        if (!this._hasInit) {\r\n            this._hasInit = true;\r\n            this.drawFullCircle();\r\n            this.playSkillAllAndRelease(partnerManager, anim);\r\n            return;\r\n        }\r\n\r\n        this.elapsed += deltaTime;\r\n        let progress = this.elapsed / this.duration;\r\n\r\n        if (progress >= 1) {\r\n            progress = 1;\r\n            this.drawFullCircle();\r\n            this.playSkillAllAndRelease(partnerManager, anim);\r\n            return;\r\n        }\r\n\r\n        // 绘制冷却进度\r\n        const startAngle = Math.PI / 2;\r\n        const endAngle = startAngle + Math.PI * 2 * progress;\r\n        this.progressBarGraphics.clear();\r\n        this.progressBarGraphics.moveTo(0, 0);\r\n        this.progressBarGraphics.arc(0, 0, this.radius, startAngle, endAngle, true);\r\n        this.progressBarGraphics.lineTo(0, 0);\r\n        this.progressBarGraphics.fill();\r\n    }\r\n\r\n    private drawFullCircle() {\r\n        this.progressBarGraphics.clear();\r\n        this.progressBarGraphics.moveTo(0, 0);\r\n        this.progressBarGraphics.arc(0, 0, this.radius, Math.PI / 2, Math.PI / 2 + Math.PI * 2, true);\r\n        this.progressBarGraphics.lineTo(0, 0);\r\n        this.progressBarGraphics.fill();\r\n    }\r\n\r\n    private playSkillAllAndRelease(partnerManager: any, anim: Animation | null) {\r\n        if (!partnerManager) return;\r\n\r\n        partnerManager.isSkillAllPlaying = true;\r\n\r\n        const skillState = anim?.getState(\"skillALL\");\r\n        if (anim && skillState) {\r\n            // 防止重复绑定和重复播放\r\n            anim.off(Animation.EventType.FINISHED);\r\n            anim.stop();\r\n            anim.play(\"skillALL\");\r\n\r\n            this._hasPlayedSkillFinish = false;\r\n\r\n            anim.once(Animation.EventType.FINISHED, () => {\r\n                if (this._hasPlayedSkillFinish) return;\r\n                this._hasPlayedSkillFinish = true;\r\n\r\n                partnerManager.releaseMajorSkills();\r\n\r\n                // 获取方向动画\r\n                const direction = partnerManager.direction;\r\n                const aniName = partnerManager.node.name.slice(0, -1);\r\n                const clipName = `${aniName}${direction}`; \r\n\r\n                const anim = partnerManager.getComponent(Animation);\r\n                const dirState = anim?.getState(clipName);\r\n                // console.log(\"=========> 播放方向动画\", clipName);\r\n\r\n                if (dirState) {\r\n                    dirState.stop();\r\n                    anim.play(clipName);\r\n\r\n                    // 第二段动画播放完成后恢复 idle\r\n                    anim.once(Animation.EventType.FINISHED, () => {\r\n                        anim.play(\"idleB\");\r\n                        partnerManager.isSkillAllPlaying = false;\r\n                        this.elapsed = 0;\r\n                    });\r\n                } else {\r\n                    console.warn(`❌ 未找到方向动画 ${clipName}`);\r\n                    anim.play(\"idleB\");\r\n                    partnerManager.isSkillAllPlaying = false;\r\n                    this.elapsed = 0;\r\n                }\r\n            });\r\n        } else {\r\n            // 没有动画直接执行技能释放\r\n            partnerManager.releaseMajorSkills();\r\n            partnerManager.isSkillAllPlaying = false;\r\n            this.elapsed = 0;\r\n        }\r\n    }\r\n\r\n\r\n    updateUiFollow() {\r\n        // 如果需要UI跟随，这里写逻辑\r\n    }\r\n}\r\n"]}