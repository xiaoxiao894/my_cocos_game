import { _decorator, Collider, Component, ITriggerEvent, Label, math, Node, SkeletalAnimation, tween, Tween, v3, Vec3 } from 'cc';
import { BuildingType, CommonEvent, ObjectType } from '../../common/CommonEnum';
import { PoolManager } from '../PoolManager';
import { DropItemCom } from '../Drop/DropItemCom';
import { SpherePackingSimulator } from '../PackingSimulator/PackingSimulator';
const { ccclass, property } = _decorator;

/** 道具堆放区 -- 爆炸水果 */
@ccclass('StackArea_fruit')
export class StackArea_fruit extends Component {
    private _stackItemType: ObjectType = ObjectType.StackItemExplosionFruit;

    // 若干个随机堆叠的道具世界坐标
    readonly wposList: number[] = [10.282036781311035, 0.9987772107124329, -8.20273208618164, 17.33218002319336, 0.999717652797699, -5.850155830383301, 11.91064453125, 0.9998920559883118, -1.8005882501602173, 3.000173807144165, 0.9997002482414246, -9.747614860534668, 6.797726631164551, 0.9999547004699707, -14.181135177612305, 12.518332481384277, 1.0000176429748535, -8.35758113861084, 14.839052200317383, 0.9992822408676147, -7.710590362548828, 6.804652690887451, 1.0000311136245728, -6.698813438415527, 10.94848346710205, 0.9995942115783691, -14.186668395996094, 7.268754959106445, 1.0000728368759155, -10.806757926940918, 8.652616500854492, 0.9997276067733765, -3.804914951324463, 17.46726417541504, 1.0000172853469849, -11.45040225982666, 14.80360221862793, 0.9996994137763977, -12.330077171325684, 9.01384162902832, 1.0000144243240356, -14.693863868713379, 11.790877342224121, 0.9994996786117554, -12.014777183532715, 11.14390754699707, 0.9996375441551208, -4.045669078826904, 6.5846357345581055, 0.9997486472129822, -3.513568639755249, 13.13764476776123, 0.9989854693412781, -5.338568687438965, 7.8569560050964355, 0.9998847246170044, -1.9703871011734009, 13.957521438598633, 0.9998248815536499, -1.7568742036819458, 8.82664680480957, 0.9998416900634766, -6.589910984039307, 17.496286392211914, 1.0000442266464233, -8.02417278289795, 13.127839088439941, 1.0000057220458984, -13.56529712677002, 3.0311505794525146, 0.9999973177909851, -1.773711919784546, 9.390250205993652, 1.0000089406967163, -10.808195114135742, 14.881433486938477, 1.0000243186950684, -3.68118953704834, 11.214858055114746, 0.9999379515647888, -9.990762710571289, 1.8947474956512451, 0.9999958872795105, -7.524999618530273, 15.702901840209961, 1.0000073909759521, -14.959440231323242, 4.567865371704102, 0.9999067187309265, -15.459405899047852, 11.266430854797363, 0.999930202960968, -6.044949531555176, 4.442717552185059, 0.9989972710609436, -6.747136116027832, 6.300403594970703, 0.9996996521949768, -8.836286544799805, 3.1753716468811035, 0.9999880194664001, -12.399162292480469, 15.412445068359375, 0.9999536871910095, -9.797139167785645, 9.975372314453125, 0.9999479651451111, -2.305711269378662, 13.285544395446777, 1.0000267028808594, -10.536693572998047, 10.007413864135742, 1.7119677066802979, -12.572128295898438, 8.273722648620605, 1.0000008344650269, -8.511670112609863, 3.69830060005188, 0.9998310208320618, -4.713314533233643, 15.158153533935547, 1.000037670135498, -5.736286640167236, 4.9916911125183105, 1.0000249147415161, -11.461687088012695, 17.893333435058594, 1.0000163316726685, -14.643610954284668, 3.4713754653930664, 2.0716521739959717, -8.127436637878418, 18.51781463623047, 0.9999964833259583, -3.8071038722991943, 4.766075611114502, 1.9375144243240356, -9.710311889648438, 5.591689109802246, 1.4770065546035767, -5.182621955871582, 8.1400728225708, 0.9994341731071472, -12.60610294342041, 8.035713195800781, 2.5407304763793945, -13.87597942352295, 14.112485885620117, 0.9999796152114868, -16.232036590576172, 13.37995719909668, 2.142049789428711, -6.960785865783691, 6.402110576629639, 1.9814398288726807, -12.484395980834961, 1.5659348964691162, 0.9999872446060181, -11.163524627685547, 5.6174540519714355, 0.9996609687805176, -1.6148252487182617, 1.8673779964447021, 1.000002145767212, -5.524770259857178, 12.969085693359375, 1.5208746194839478, -3.415506362915039, 4.901195049285889, 0.9999932050704956, -13.459409713745117, 7.7407145500183105, 2.0244743824005127, -5.259498119354248, 10.327105522155762, 0.9999768137931824, -17.68194580078125, 9.78156852722168, 1.980822205543518, -5.132342338562012, 8.837557792663574, 2.6110997200012207, -2.63460373878479, 12.10086441040039, 2.6311795711517334, -14.095261573791504, 16.09414291381836, 2.3486504554748535, -8.487664222717285, 19.25441551208496, 1.0000016689300537, -9.206477165222168, 15.421419143676758, 2.2730884552001953, -2.2378227710723877, 15.927362442016602, 2.2616779804229736, -11.260883331298828, 6.661012649536133, 2.574780225753784, -2.2693932056427, 4.405246734619141, 1.7675652503967285, -3.0075299739837646, 13.96799373626709, 2.177734136581421, -9.071669578552246, 6.265768051147461, 0.9999924302101135, -17.1298770904541, 9.702315330505371, 2.4421446323394775, -9.458542823791504, 5.639903545379639, 2.383315324783325, -7.55271053314209, 13.245660781860352, 0.9999935626983643, 1.5404738187789917, 11.135241508483887, 2.5557541847229004, -2.7893781661987305, 1.2091673612594604, 0.9999814033508301, -14.516420364379883, 14.290860176086426, 2.543882369995117, -4.80707311630249, 7.7718424797058105, 2.71172833442688, -9.90419864654541, 5.907501697540283, 0.9999821186065674, 1.946023941040039, 3.08542799949646, 1.6532238721847534, -14.28667163848877, 16.646242141723633, 0.9999252557754517, -16.72285270690918, 13.309515953063965, 2.2996935844421387, -12.05650806427002, 10.358587265014648, 1.8782203197479248, -15.885583877563477, 8.462552070617676, 2.796398162841797, -11.790526390075684, 11.942103385925293, 2.56352162361145, -4.999409198760986, 0.1596893072128296, 0.9999091625213623, -4.483640193939209, 3.768994092941284, 2.576472520828247, -11.321634292602539, 14.635370254516602, 2.280411958694458, -13.856769561767578, 9.474228858947754, 2.6747937202453613, -7.469824314117432, 5.569796085357666, 2.5145812034606934, -14.624537467956543, 11.046219825744629, 2.6328012943267822, -11.132997512817383, 16.963184356689453, 0.9998469948768616, -2.275219440460205, 11.45809555053711, 2.423372507095337, -7.435943603515625, 14.771354675292969, 3.474513292312622, -7.496777534484863, 8.122117042541504, 1, 1.454041838645935, 7.497312068939209, 3.4388298988342285, -3.8668901920318604, 9.222555160522461, 4.096171855926514, -10.47537612915039, 3.1950840950012207, 2.3986668586730957, -6.051654815673828, 16.686279296875, 1.7449712753295898, -4.110361099243164, 5.140091896057129, 3.7411866188049316, -8.933401107788086, 13.079571723937988, 1.9314552545547485, -0.22038869559764862, 6.265561580657959, 3.2351038455963135, -5.855343818664551, 19.451271057128906, 0.9999653100967407, -11.19914436340332, 19.1657657623291, 1, -6.850912094116211, 10.107141494750977, 0.9999535083770752, 1.69649338722229, 12.22243595123291, 0.9999995827674866, -18.32014274597168, 2.557152032852173, 0.9999991059303284, -17.140775680541992, 5.529994487762451, 3.089184522628784, -4.001319885253906, 9.925728797912598, 3.610342264175415, -3.9825081825256348, 7.538693428039551, 2.8849904537200928, -7.926075458526611, 16.566232681274414, 1.3754847049713135, -13.195218086242676, 17.620101928710938, 2.022627830505371, -9.738603591918945, 14.726698875427246, 3.5489556789398193, -10.311962127685547, 0.935775876045227, 0.9999997019767761, -1.8770415782928467, 12.0517578125, 2.690516471862793, -9.326605796813965, 12.726308822631836, 3.9677977561950684, -7.4492645263671875, 15.44732666015625, 0.9999799132347107, 1.7347365617752075, 10.07425308227539, 2.892086982727051, -14.18532657623291, 20.174049377441406, 0.9999862909317017, -13.063838958740234, 6.657551288604736, 0.9999743700027466, 0.0920947939157486, 12.925116539001465, 2.896951198577881, -1.9649662971496582, 13.49731159210205, 3.835833787918091, -13.3233060836792, 11.343867301940918, 0.9998859167098999, 0.1248256117105484, 5.921798229217529, 3.0747742652893066, -10.880305290222168, 10.572157859802246, 3.5681304931640625, -6.0565290451049805, 8.165457725524902, 0.9999864101409912, -16.50472068786621, 12.154379844665527, 0.9999774098396301, -15.82538890838623, 16.229629516601562, 2.53605318069458, -6.5011444091796875, 4.413636207580566, 0.9999991059303284, -17.884563446044922, 14.763858795166016, 1, -18.689767837524414, 4.200919151306152, 3.717569589614868, -7.168083667755127, 12.806975364685059, 3.787468671798706, -10.818629264831543, 0.8161761164665222, 1.0000044107437134, -9.213274002075195, 2.059866189956665, 0.9999977350234985, -3.5312719345092773, 8.574259757995605, 3.685469150543213, -5.998176574707031, 10.457916259765625, 2.463735818862915, -0.9099072813987732, 9.17135238647461, 0.9999870657920837, -0.463071346282959, 7.018296718597412, 4.393505573272705, -9.130163192749023, 15.280828475952148, 0.9999844431877136, -0.2578429877758026, 3.676562547683716, 0.9999998211860657, 1.8251924514770508, 1.693909764289856, 2.6176669597625732, -9.995525360107422];

    protected onLoad(): void {
        app.event.on(CommonEvent.UnlockItem, this.onUnlockItem, this);
        manager.game.registerBuilding(BuildingType.ExplosionFruitStack, this.node, this.node.getWorldPosition());
        this.node.active = false;
    }

    protected onUnlockItem(itemType: BuildingType) {
        if (itemType == BuildingType.ExplosionFruitStack) {
            this.node.active = true;
        }
    }

    protected start(): void {
        this._showChildren();
        this.scheduleOnce(() => {
            this._createFruit();
        }, 0.2);
    }

    _showChildren() {
        let children = this.node.children;
        for (let i = 0; i < children.length; i++) {
            let child = children[i];
            child.scale = Vec3.ZERO;
            let delayTime = Math.min(0.6, i * 0.1);
            tween(child)
                .delay(delayTime)
                .to(0.2, { scale: Vec3.ONE })
                .start();
        }
    }

    private _minZ: number = -19;
    private _maxZ: number = -1;
    private _minX: number = 0;
    private _maxX: number = 19;

    _createFruit() {
        // 播放音效
        for (let i = 0; i < 5; i++) {
            let delayTime = Math.min(0.8, i * 0.2);
            this.scheduleOnce(() => {
                app.audio.playEffect('resources/MQBY/农作物冒出');
            }, delayTime);
        }

        for (let i = 0; i < this.wposList.length / 3; i++) {
            let x = this.wposList[i * 3];
            let y = this.wposList[i * 3 + 1];
            let z = this.wposList[i * 3 + 2];
            if (z < this._minZ || z > this._maxZ || x < this._minX || x > this._maxX) {
                continue;
            }
            let item = manager.pool.getNode(this._stackItemType, this.node);
            item.setWorldPosition(x, y, z);
            // 有个从小到大的过程
            tween(item).set({ scale: Vec3.ZERO }).to(0.5 + math.random() * 0.4, { scale: Vec3.ONE }).start();
        }
    }

    public _testSaveAllStackItemWpos() {
        let items = this.node.children;
        let wposList = [];
        for (let i = 0; i < items.length; i++) {
            const itemNode = items[i];
            let item = itemNode.getChildByPath('ExplosionFruit/Sphere')
            let wpos = item.worldPosition;
            wposList.push(wpos.x, wpos.y, wpos.z);
        }

        let jsonStr = JSON.stringify(wposList);
        console.log(jsonStr);
    }
}