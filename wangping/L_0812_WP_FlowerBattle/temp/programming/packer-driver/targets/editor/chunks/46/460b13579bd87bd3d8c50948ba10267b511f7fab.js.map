{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_0812_WP_FlowerBattle/assets/JavaScript/UI/UIJoyStick.ts"],"names":["_decorator","CCFloat","Component","Input","math","Node","Sprite","UIOpacity","v3","Vec3","VirtualInput","GlobeVariable","App","ccclass","property","UIJoyStick","initJoyStickBgPosition","uiOpacity","lastHorizontal","lastVertical","t","loopCount","isPaused","pauseTimer","handStartPos","start","isTouching","node","getComponent","addComponent","opacity","on","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","TOUCH_CANCEL","joyStickBg","worldPosition","hand","getPosition","clone","onDestroy","off","event","playerController","playMove","isDeactivateVirtualJoystick","isGameEnd","isCameraMoveEnd","active","x","touch","getUILocationX","y","getUILocationY","setWorldPosition","isJoyStickBan","worldPos","localPos","inverseTransformPoint","thumbnailPos","len","length","normalize","scaleAndAdd","clamp","radius","thumbnail","setPosition","targetHorizontal","position","targetVertical","smoothFactor","horizontal","vertical","playIdle","ZERO","update","dt","pauseDuration","speed","xRaw","amplitudeX","Math","sin","yRaw","amplitudeY","cos","offset","handPos","add","PI"],"mappings":"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","sourcesContent":["import { _decorator, CCFloat, Component, EventTouch, Input, math, Node, Sprite, UIOpacity, v3, Vec3 } from 'cc';\r\n\r\n\r\nimport { VirtualInput } from './VirtuallInput';\r\nimport { GlobeVariable } from '../core/GlobeVariable';\r\nimport { App } from '../App';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('UIJoyStick')\r\nexport class UIJoyStick extends Component {\r\n    @property(Sprite)\r\n    thumbnail: Sprite | null = null;\r\n\r\n    @property(Sprite)\r\n    joyStickBg: Sprite | null = null;\r\n\r\n    @property(Node)\r\n    hand: Node | null = null;\r\n\r\n    @property(CCFloat)\r\n    radius: number = 130;\r\n\r\n    initJoyStickBgPosition: Vec3 = v3();\r\n\r\n    uiOpacity = null;\r\n\r\n    @property\r\n    amplitudeX: number = 50;\r\n\r\n    @property\r\n    amplitudeY: number = 80;\r\n\r\n    @property\r\n    speed: number = 0.3;\r\n\r\n    @property\r\n    pauseDuration: number = 1.0; // 停顿时间（秒）\r\n\r\n    // 添加平滑系数和缓存变量\r\n    @property\r\n    smoothFactor: number = 0.2; // 平滑系数，值越小平滑效果越明显（范围0-1）\r\n\r\n    private lastHorizontal: number = 0;\r\n    private lastVertical: number = 0;\r\n\r\n    private t = 0;\r\n    private loopCount = 0;\r\n    private isPaused = false;\r\n    private pauseTimer = 0;\r\n    private handStartPos: Vec3 = new Vec3();\r\n\r\n    start() {\r\n        if (GlobeVariable.isTouching) {\r\n            this.uiOpacity = this.node.getComponent(UIOpacity) || this.node.addComponent(UIOpacity);\r\n            this.uiOpacity.opacity = 0;\r\n        }\r\n\r\n\r\n\r\n        this.node.on(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.node.on(Input.EventType.TOUCH_MOVE, this.onTouchMove, this)\r\n        this.node.on(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.on(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n\r\n        this.initJoyStickBgPosition = this.joyStickBg.node.worldPosition;\r\n\r\n        if (this.hand) {\r\n            this.handStartPos = this.hand.getPosition().clone();\r\n        }\r\n    }\r\n\r\n    onDestroy() {\r\n        this.node.off(Input.EventType.TOUCH_START, this.onTouchStart, this);\r\n        this.node.off(Input.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        this.node.off(Input.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        this.node.off(Input.EventType.TOUCH_CANCEL, this.onTouchEnd, this);\r\n    }\r\n\r\n    onTouchStart(event: EventTouch) {\r\n        //  GlobeVariable.isStartGame = true;\r\n        //  App.sceneNode.enemyParent.active = true;\r\n        if (App.playerController?.playMove)\r\n            App.playerController.playMove();\r\n        if (GlobeVariable.isDeactivateVirtualJoystick || GlobeVariable.isGameEnd || !GlobeVariable.isCameraMoveEnd) return;\r\n        GlobeVariable.isTouching = true;\r\n        if (this.hand) this.hand.active = false;\r\n\r\n        let x = event.touch.getUILocationX();\r\n        let y = event.touch.getUILocationY();\r\n\r\n        this.joyStickBg.node.setWorldPosition(x, y, 0)\r\n\r\n        if (this.uiOpacity) this.uiOpacity.opacity = 255;\r\n    }\r\n\r\n    onTouchMove(event: EventTouch) {\r\n        if (GlobeVariable.isDeactivateVirtualJoystick || GlobeVariable.isGameEnd || GlobeVariable.isJoyStickBan || !GlobeVariable.isCameraMoveEnd) return;\r\n\r\n        let x = event.touch.getUILocationX();\r\n        let y = event.touch.getUILocationY();\r\n\r\n        let worldPos = new Vec3(x, y, 0);\r\n        let localPos = v3();\r\n\r\n        this.joyStickBg.node.inverseTransformPoint(localPos, worldPos);\r\n        let thumbnailPos = v3();\r\n        let len = localPos.length();\r\n        localPos.normalize();\r\n        Vec3.scaleAndAdd(thumbnailPos, v3(), localPos, math.clamp(len, 0, this.radius));\r\n\r\n        this.thumbnail.node.setPosition(thumbnailPos);\r\n\r\n\r\n        // 计算目标值\r\n        const targetHorizontal = this.thumbnail.node.position.x / this.radius;\r\n        const targetVertical = this.thumbnail.node.position.y / this.radius;\r\n\r\n        // 使用线性插值进行平滑处理\r\n        this.lastHorizontal = this.lastHorizontal + (targetHorizontal - this.lastHorizontal) * this.smoothFactor;\r\n        this.lastVertical = this.lastVertical + (targetVertical - this.lastVertical) * this.smoothFactor;\r\n\r\n        // 设置平滑后的值\r\n        VirtualInput.horizontal = this.lastHorizontal;\r\n        VirtualInput.vertical = this.lastVertical;\r\n    }\r\n\r\n    onTouchEnd(event: EventTouch) {\r\n        // if (DataManager.Instance.isDeactivateVirtualJoystick) return;\r\n        App.playerController.playIdle();\r\n        VirtualInput.horizontal = 0;\r\n        VirtualInput.vertical = 0;\r\n        // 重置缓存值\r\n        this.lastHorizontal = 0;\r\n        this.lastVertical = 0;\r\n\r\n        this.thumbnail.node.setPosition(Vec3.ZERO);\r\n        this.joyStickBg.node.setWorldPosition(this.initJoyStickBgPosition);\r\n\r\n        if (GlobeVariable.isTouching) {\r\n            this.uiOpacity = this.node.getComponent(UIOpacity) || this.node.addComponent(UIOpacity);\r\n            this.uiOpacity.opacity = 0;\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (GlobeVariable.isTouching) return;\r\n\r\n        if (this.isPaused) {\r\n            this.pauseTimer += dt;\r\n            if (this.pauseTimer >= this.pauseDuration) {\r\n                this.pauseTimer = 0;\r\n                this.isPaused = false;\r\n                this.t = 0;\r\n            }\r\n            return;\r\n        }\r\n\r\n        this.t += dt * this.speed;\r\n\r\n        const xRaw = this.amplitudeX * Math.sin(this.t);\r\n        const yRaw = this.amplitudeY * Math.sin(this.t) * Math.cos(this.t);\r\n\r\n        const x = yRaw;\r\n        const y = -xRaw;\r\n\r\n        const offset = new Vec3(x, y, 0);\r\n        this.thumbnail.node.setPosition(offset);\r\n\r\n        if (this.hand) {\r\n            const handPos = this.handStartPos.clone().add(offset);\r\n            this.hand.setPosition(handPos);\r\n        }\r\n\r\n\r\n        if (this.t >= Math.PI * 2) {\r\n            this.loopCount += 1;\r\n            this.t = 0;\r\n\r\n            if (this.loopCount >= 2) {\r\n                this.loopCount = 0;\r\n                this.thumbnail.node.setPosition(Vec3.ZERO);\r\n                if (this.hand) this.hand.setPosition(this.handStartPos);\r\n                this.isPaused = true;\r\n            }\r\n        }\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}