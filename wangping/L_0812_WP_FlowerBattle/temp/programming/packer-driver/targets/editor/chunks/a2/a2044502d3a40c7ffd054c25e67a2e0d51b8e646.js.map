{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_0812_WP_FlowerBattle/assets/JavaScript/core/AspectAdapter38_Safe.ts"],"names":["_decorator","Component","view","ResolutionPolicy","director","Widget","Layout","Camera","ccclass","property","executeInEditMode","AspectAdapter38_Safe","tooltip","type","_pending","_applying","_lastKey","_onResize","scheduleOnce","_applyNow","width","sw","height","sh","getVisibleSize","aspect","threshold","side","designWidth","policy","FIXED_HEIGHT","key","setDesignResolutionSize","_refreshUIOnce","mainCamera","orthoHeight","greaterThanCameraZoomRatio","console","log","dw","dh","designHeight","FIXED_WIDTH","lessThanCameraZoomRatio","scene","getScene","w","getComponentsInChildren","updateAlignment","l","updateLayout","onLoad","onEnable","on","onDisable","off"],"mappings":"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","sourcesContent":["import {\r\n  _decorator, Component, view, ResolutionPolicy,\r\n  director, Widget, Layout,\r\n  Camera\r\n} from 'cc';\r\n//import { DataManager } from '../Global/DataManager';\r\nconst { ccclass, property, executeInEditMode } = _decorator;\r\n\r\n@ccclass('AspectAdapter38_Safe')\r\n@executeInEditMode()\r\nexport class AspectAdapter38_Safe extends Component {\r\n  @property({ tooltip: '设计分辨率宽' }) designWidth = 720;\r\n  @property({ tooltip: '设计分辨率高' }) designHeight = 1280;\r\n  @property({ tooltip: '宽高比值' }) threshold = 1.0;\r\n  @property({ tooltip: '镜头小于1:1' }) greaterThanCameraZoomRatio = 1;\r\n  @property({ tooltip: '镜头大于1:1' }) lessThanCameraZoomRatio = 2;\r\n\r\n  @property({type:Camera, tooltip: '镜头小于1:1' })\r\n  mainCamera: Camera | null = null;\r\n\r\n\r\n  private _pending = false;          \r\n  private _applying = false;         \r\n  private _lastKey: string | null = null; \r\n\r\n  onLoad() {\r\n    this._onResize();\r\n  }\r\n\r\n  onEnable() {\r\n    view.on('canvas-resize', this._onResize, this);\r\n    this._onResize();                 // 启用时触发一次\r\n  }\r\n\r\n  onDisable() {\r\n    view.off('canvas-resize', this._onResize, this);\r\n  }\r\n\r\n  private _onResize = () => {\r\n    if (this._pending) return;\r\n    this._pending = true;\r\n    // 延后一帧处理，等引擎内部尺寸稳定\r\n    this.scheduleOnce(this._applyNow, 0);\r\n  };\r\n\r\n  private _applyNow = () => {\r\n    this._pending = false;\r\n    if (this._applying) return;\r\n    this._applying = true;\r\n\r\n    const { width: sw, height: sh } = view.getVisibleSize();\r\n    if (sw <= 0 || sh <= 0) { this._applying = false; return; }\r\n\r\n    const aspect = sw / sh;\r\n\r\n    if (aspect >= this.threshold) {\r\n      // 宽/高 ≥ 1：保持 1:1，不再变化 高\r\n      const side = this.designWidth;\r\n      const policy = ResolutionPolicy.FIXED_HEIGHT;\r\n      const key = `${policy}:${side}x${side}`;\r\n      if (this._lastKey !== key) {\r\n        this._lastKey = key;\r\n        view.setDesignResolutionSize(side, side, policy);\r\n        this.scheduleOnce(this._refreshUIOnce, 0);\r\n        if (this.mainCamera) {\r\n          this.mainCamera.orthoHeight = this.greaterThanCameraZoomRatio;\r\n        }\r\n        console.log(\"大于1： 1\");\r\n      }\r\n\r\n    } else {\r\n      // 宽/高 < 1：正常缩放  宽\r\n      const dw = this.designWidth, dh = this.designHeight;\r\n      const policy = ResolutionPolicy.FIXED_WIDTH;  // 随宽\r\n      const key = `${policy}:${dw}x${dh}`;\r\n      if (this._lastKey !== key) {\r\n        this._lastKey = key;\r\n        view.setDesignResolutionSize(dw, dh, policy);\r\n        this.scheduleOnce(this._refreshUIOnce, 0);\r\n        if (this.mainCamera) {\r\n          this.mainCamera.orthoHeight = this.lessThanCameraZoomRatio;\r\n        }\r\n        console.log(\"小于1： 1\");\r\n\r\n      }\r\n    }\r\n    this._applying = false;\r\n  };\r\n\r\n  private _refreshUIOnce = () => {\r\n    const scene = director.getScene();\r\n    if (!scene) return;\r\n\r\n    for (const w of scene.getComponentsInChildren(Widget)) w.updateAlignment();\r\n    for (const l of scene.getComponentsInChildren(Layout)) l.updateLayout();\r\n  };\r\n}"]}