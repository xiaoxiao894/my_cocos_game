{"version":3,"sources":["file:///D:/Cocos/PlayAble/L_0812_WP_FlowerBattle/assets/JavaScript/Entitys/GoldMineController.ts"],"names":["GoldMineController","Vec3","App","GlobeVariable","MathUtil","_coinLackPos","_coinNum","_coinWidth","_coinHeight","_coinLengthNum","_coinWidthNum","_maxCoin","_playingAniNum","Instance","_instance","addCoin","worldPos","coinItem","poolManager","getNode","entifyName","Coin","setParent","sceneNode","goldMineParent","setWorldPosition","pos","getNextPosWithLength","setPosition","getPosition","clone","isPositionGreater","getWorldPosition","getGoldMineNum","playerGetCoin","removeCoin","coin","addPlayingAniNum","reducePlayingAniNum","getPlayingAniNum","pos1","pos2","y","x","z","getNextCoinPos","aniNum","length","shift","targetPos","localToWorldPos3D","addNum","count","nowLayerNumber","Math","floor","coinNodes","children","sort","a","b","position","worldPosition","returnNode","updateCoinLack","indexOf","push","i","item","splice"],"mappings":"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","sourcesContent":["import { Mat4, Vec3,Node } from \"cc\";\r\nimport { App } from \"../App\";\r\nimport { GlobeVariable } from \"../core/GlobeVariable\";\r\nimport { MathUtil } from \"../core/MathUtils\";\r\n\r\n//类型定义 \r\nexport type CoinItem = {\r\n    pos: Vec3, //世界坐标\r\n    coin: Node \r\n}\r\n\r\n/** 金矿管理类 */\r\nexport default class GoldMineController {\r\n\r\n    private _coinLackPos: Vec3[] = [];\r\n    private _coinNum: number = 0;\r\n\r\n    //钱的尺寸\r\n    private _coinWidth: number = 1.2;\r\n    private _coinHeight: number = 0.2;\r\n\r\n    //钱池个数\r\n    private _coinLengthNum: number = 3;\r\n    private _coinWidthNum: number = 4;\r\n\r\n    //按顺序排列，最后一个金币的位置\r\n    private _maxCoin: Vec3;\r\n\r\n    // 正在在播放动画的数量\r\n    private _playingAniNum: number = 0;\r\n\r\n    private static _instance: GoldMineController;\r\n    public static get Instance(): GoldMineController {\r\n        if (!GoldMineController._instance) {\r\n            GoldMineController._instance = new GoldMineController();\r\n        }\r\n        return GoldMineController._instance;\r\n    }\r\n\r\n    /** 增加金币 */\r\n    public addCoin(worldPos?: Vec3): void {\r\n        let coinItem: Node = App.poolManager.getNode(GlobeVariable.entifyName.Coin);\r\n\r\n        coinItem.setParent(App.sceneNode.goldMineParent);\r\n\r\n        if (worldPos) {\r\n            coinItem.setWorldPosition(worldPos);\r\n        } else {\r\n            let pos = this.getNextPosWithLength();\r\n\r\n            coinItem.setPosition(pos);\r\n        }\r\n\r\n        if (!this._maxCoin) {\r\n            this._maxCoin = coinItem.getPosition().clone();\r\n        } else {\r\n            if (this.isPositionGreater(coinItem.getWorldPosition(), this._maxCoin)) {\r\n                this._maxCoin = coinItem.getWorldPosition().clone();\r\n            }\r\n        }\r\n        this._coinNum++;\r\n    }\r\n    public getGoldMineNum(){\r\n        return this._coinNum;\r\n    }\r\n    \r\n    public playerGetCoin(): CoinItem | null {\r\n        let worldPos = this.removeCoin();\r\n        if (worldPos == null) {\r\n            return null;\r\n        } else {\r\n            return {\r\n                pos: worldPos,\r\n                coin: App.poolManager.getNode(GlobeVariable.entifyName.Coin)\r\n            };\r\n        }\r\n    }\r\n\r\n    public addPlayingAniNum(): void {\r\n        this._playingAniNum++;\r\n    }\r\n\r\n    public reducePlayingAniNum(): void {\r\n        this._playingAniNum--;\r\n    }\r\n\r\n    public getPlayingAniNum(): number {\r\n        return this._playingAniNum;\r\n    }\r\n\r\n    private isPositionGreater(pos1: Vec3, pos2: Vec3): boolean {\r\n        if (pos1.y > pos2.y) return true;\r\n        if (pos1.y < pos2.y) return false;\r\n\r\n        // y 相等时比较 x\r\n        if (pos1.x > pos2.x) return true;\r\n        if (pos1.x < pos2.x) return false;\r\n\r\n        // x 和 y 相等时比较 z\r\n        return pos1.z > pos2.z;\r\n    }\r\n\r\n    public getNextCoinPos(aniNum:number): Vec3 {\r\n        if (this._coinLackPos.length > 0) {\r\n            return this._coinLackPos.shift();\r\n        } else {\r\n            let targetPos = this.getNextPosWithLength(aniNum);\r\n            let worldPos = new Vec3();\r\n            worldPos = MathUtil.localToWorldPos3D(targetPos, App.sceneNode.goldMineParent);\r\n\r\n            return worldPos;\r\n        }\r\n    }\r\n\r\n    private getNextPosWithLength(addNum:number = 0): Vec3 {\r\n        let count:number = addNum+this._coinNum;\r\n        let pos = new Vec3(0, 0, 0);\r\n        //本层数量\r\n        let nowLayerNumber = count % (this._coinLengthNum * this._coinWidthNum);\r\n        pos.y = Math.floor(count / (this._coinLengthNum * this._coinWidthNum)) * this._coinHeight; //钱的高度\r\n        pos.z = nowLayerNumber % this._coinWidthNum * this._coinWidth + this._coinWidth / 2; //钱的宽度\r\n        pos.x = Math.floor(nowLayerNumber / this._coinWidthNum) * this._coinWidth + this._coinWidth / 2; //钱的长度\r\n        return pos;\r\n    }\r\n\r\n    private removeCoin(): Vec3 {\r\n        if (this._coinNum > 0) {\r\n            let coinNodes:Node[]= App.sceneNode.goldMineParent.children;\r\n            coinNodes.sort((a: Node, b: Node) => {\r\n                // 1. 优先比较 y，大的在后\r\n                if (a.position.y !== b.position.y) {\r\n                    return a.position.y - b.position.y; // 升序（y小的在前）\r\n                }\r\n\r\n                // 2. y 相等时，比较 x，大的在后\r\n                if (a.position.x !== b.position.x) {\r\n                    return a.position.x - b.position.x; // 升序（x小的在前）\r\n                }\r\n\r\n                // 3. x 和 y 都相等时，比较 z，大的在后\r\n                return a.position.z - b.position.z; // 升序（z小的在前）\r\n            });\r\n            let coinItem: Node = coinNodes[coinNodes.length - 1];\r\n            this._coinNum--;\r\n            if (coinItem) {\r\n                let pos = coinItem.worldPosition.clone();\r\n                App.poolManager.returnNode(coinItem,GlobeVariable.entifyName.Coin);\r\n                this.updateCoinLack(pos);\r\n                return pos;\r\n            } else {\r\n                return this.removeCoin();\r\n            }\r\n\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    private updateCoinLack(pos: Vec3) {\r\n        //如果当前没有这个坐标再加入\r\n        if (this._coinLackPos.indexOf(pos) !== -1) {\r\n            return;\r\n        }\r\n\r\n        this._coinLackPos.push(pos);\r\n        this._coinLackPos.sort((a, b) => {\r\n            // 1. 优先比较 y，大的在后\r\n            if (a.y !== b.y) {\r\n                return a.y - b.y; // 升序（y小的在前）\r\n            }\r\n\r\n            // 2. y 相等时，比较 x，大的在后\r\n            if (a.x !== b.x) {\r\n                return a.x - b.x; // 升序（x小的在前）\r\n            }\r\n\r\n            // 3. x 和 y 都相等时，比较 z，大的在后\r\n            return a.z - b.z; // 升序（z小的在前）\r\n        });\r\n\r\n        for (let i = 0; i < this._coinLackPos.length; i++) {\r\n            let item = this._coinLackPos[i];\r\n            if (this.isPositionGreater(item, this._maxCoin)) {\r\n                this._coinLackPos.splice(i, this._coinLackPos.length - i);\r\n                break;\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n}"]}